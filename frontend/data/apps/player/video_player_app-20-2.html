<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Raw Video Player v11.2 (Thumbnails & Layout)</title>
    <style>
        /* --- åŸºç¡€é‡ç½® --- */
        body { margin: 0; background: #000; color: #fff; height: 100vh; overflow: hidden; font-family: "Segoe UI", sans-serif; user-select: none; display: flex; }
        
        /* --- æ’­æ”¾å®¹å™¨ --- */
        #player-container {
            flex: 1; position: relative; height: 100%; background: #000;
            display: flex; justify-content: center; align-items: center;
        }

        video { 
            width: 100%; height: 100%; outline: none; 
            object-fit: contain; transition: object-fit 0.2s; 
        }

        /* --- è§†é¢‘ä¿¡æ¯å±‚ (Grid OSD) --- */
        #video-info {
            position: absolute; top: 0; left: 0; z-index: 60;
            font-family: Consolas, monospace; font-size: 11px; color: rgba(255,255,255,0.9);
            background: rgba(0,0,0,0.7); 
            padding: 6px 10px 6px 6px; 
            border-radius: 0 0 8px 0;
            pointer-events: none; backdrop-filter: blur(4px);
            transition: opacity 0.2s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            width: max-content; max-width: 80vw;
            display: flex; flex-direction: column; gap: 2px;
        }
        #video-info.hidden { display: none; }
        .immersive-active #video-info { opacity: 0; }
        
        .info-row { display: grid; grid-template-columns: 35px 1fr; gap: 10px; align-items: baseline; }
        
        .info-label { color: #aaa; text-align: left; }
        .info-val { font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* ä½ç½®ä¿¡æ¯é¢œè‰² */
        #info-pos { color: #4CAF50; }

        /* --- æ‹–æ‹½åŒºåŸŸ --- */
        #drop-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20,20,20,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 4px dashed #333; box-sizing: border-box; transition: opacity 0.3s, visibility 0.3s;
        }
        #drop-zone.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .drop-icon { font-size: 60px; margin-bottom: 20px; color: #4CAF50; }
        .drop-text { font-size: 18px; color: #aaa; margin-bottom: 10px; }

        /* --- å³ä¸Šè§’åŠŸèƒ½åŒº --- */
        #top-right-controls { 
            position: fixed; top: 20px; right: 20px; z-index: 200; 
            display: flex; gap: 10px; opacity: 0; transition: opacity 0.3s; 
        }
        #player-container:hover #top-right-controls, #top-right-controls:hover { opacity: 1; }
        
        .immersive-active #top-right-controls { opacity: 0 !important; pointer-events: none; }
        .immersive-active #top-trigger:hover ~ #top-right-controls, 
        .immersive-active #top-right-controls:hover { opacity: 1 !important; pointer-events: auto; }

        .circle-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #555; color: #eee;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s;
        }
        .circle-btn:hover { background: #4CAF50; border-color: #4CAF50; transform: scale(1.1); color: #fff; }
        .circle-btn.active { background: #4CAF50; border-color: #4CAF50; color: #000; }

        #top-trigger { position: absolute; top: 0; left: 0; width: 100%; height: 80px; z-index: 150; pointer-events: none; }
        .immersive-active #top-trigger { pointer-events: auto; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar-panel {
            position: fixed; top: 0; bottom: 0; width: 340px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹é€‚åº”ç•¥ç¼©å›¾ */
            background: rgba(30, 30, 30, 0.98); border-left: 1px solid #444;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; z-index: 300; 
            box-shadow: -5px 0 20px rgba(0,0,0,0.8);
            right: 0; transform: translateX(100%); 
        }
        .sidebar-panel.open { transform: translateX(0); }
        
        #playlist-resizer {
            position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            cursor: col-resize; z-index: 301; background: transparent;
            transition: background 0.2s;
        }
        #playlist-resizer:hover { background: rgba(76, 175, 80, 0.5); }

        .sidebar-header { 
            padding: 12px 20px; border-bottom: 1px solid #444; 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 14px; font-weight: bold; color: #fff; margin-left: 5px; 
        }
        .close-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        .close-btn:hover { color: #fff; }

        #playlist-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; margin-left: 5px; }
        
        .list-item { 
            display: flex; align-items: center; padding: 6px 10px; cursor: pointer; 
            border-bottom: 1px solid #333; height: 50px; /* å›ºå®šé«˜åº¦ */
        }
        .list-item:hover { background: #444; }
        .list-item.active { background: #1b5e20; border-left: 4px solid #4CAF50; }
        
        /* ç•¥ç¼©å›¾æ ·å¼ */
        .list-thumb {
            width: 70px; height: 40px; background: #000; border-radius: 3px; 
            margin: 0 10px; object-fit: cover; flex-shrink: 0; border: 1px solid #444;
        }
        
        .list-idx { font-size: 12px; color: #666; width: 20px; text-align: center; flex-shrink: 0; }
        .list-name { font-size: 13px; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        
        /* éšè—æ–‡ä»¶åæ—¶çš„æ ·å¼ */
        #playlist-list.hide-filenames .list-name { display: none; }
        #playlist-list.hide-filenames .list-item { justify-content: center; }
        #playlist-list.hide-filenames .list-thumb { width: 100px; height: 56px; margin: 0; }
        #playlist-list.hide-filenames .list-idx { display: none; }
        #playlist-list.hide-filenames .list-item { height: 70px; } /* çº¯å›¾æ¨¡å¼ä¸‹å¢é«˜ */

        /* åˆ—è¡¨åº•éƒ¨æ  */
        .playlist-footer {
            padding: 10px 15px; border-top: 1px solid #333; background: #1a1a1a; 
            display: flex; flex-direction: column; gap: 10px; margin-left:5px;
        }
        .footer-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #aaa; }

        .cfg-scroll-area { flex: 1; overflow-y: auto; padding: 20px; margin-left: 5px; }
        .cfg-group { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .cfg-title { color: #4CAF50; font-size: 12px; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; }
        .cfg-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cfg-label { font-size: 13px; color: #ddd; }
        
        input.cfg-num { width: 50px; background: #222; border: 1px solid #555; color: #fff; padding: 4px; border-radius: 3px; text-align: center; font-size: 12px; }

        /* --- Details/Summary --- */
        details { width: 100%; }
        summary { 
            cursor: pointer; color: #4CAF50; font-size: 13px; font-weight: bold; 
            outline: none; list-style: none; display: flex; align-items: center; justify-content: space-between; 
            padding-bottom: 5px; 
        }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: "â–¼"; font-size: 10px; transition: transform 0.2s; }
        details[open] summary::after { transform: rotate(180deg); }
        details[open] summary { border-bottom: 1px solid #444; margin-bottom: 15px; }
        
        .details-content { margin-top: 15px; padding-left: 5px; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Key Buttons --- */
        .key-btn {
            background: #222; border: 1px solid #444; color: #fff; 
            padding: 4px 10px; border-radius: 4px; cursor: pointer; 
            font-family: monospace; min-width: 80px; text-align: center; font-size: 12px;
        }
        .key-btn:hover { border-color: #888; background: #333; }
        .key-btn.recording { background: #4CAF50; border-color: #4CAF50; color: #000; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- Toggle Switch --- */
        .switch { position: relative; display: inline-block; width: 32px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(16px); }
        
        .btn-full-width { width: 100%; padding: 8px; background: #333; color: #ccc; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 13px; }
        .btn-full-width:hover { background: #444; color: #fff; }
        .btn-danger { background: #5a2a2a; color: #ffcccc; }
        .btn-danger:hover { background: #7f3a3a; }

        /* --- æ§åˆ¶æ  --- */
        #controls-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70px;
            background: linear-gradient(transparent, rgba(0,0,0,0.95));
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 0 20px 15px; box-sizing: border-box;
            opacity: 0; transition: opacity 0.3s; z-index: 50;
        }
        #player-container:hover #controls-bar { opacity: 1; }
        
        .immersive-active #controls-bar { opacity: 0 !important; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
        .immersive-active #controls-bar:hover { opacity: 1 !important; transform: translateY(0); pointer-events: auto; }
        #bottom-trigger { position: absolute; bottom: 0; left: 0; width: 100%; height: 20px; z-index: 40; pointer-events: auto; }
        .immersive-active #bottom-trigger:hover ~ #controls-bar { opacity: 1 !important; transform: translateY(0); pointer-events: auto; }

        .progress-row { width: 100%; height: 10px; display: flex; align-items: center; cursor: pointer; margin-bottom: 10px; position: relative; }
        .progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; width: 100%; }
        .progress-fill { height: 100%; background: #4CAF50; width: 0%; border-radius: 2px; position: absolute; top: 0; left: 0; pointer-events: none; }
        .progress-thumb { width: 12px; height: 12px; background: #fff; border-radius: 50%; position: absolute; top: -4px; left: 0%; transform: translateX(-50%); pointer-events: none; transition: transform 0.1s; }
        .progress-row:hover .progress-fill { background: #66bb6a; }
        .progress-row:hover .progress-thumb { transform: translateX(-50%) scale(1.3); }

        .buttons-row { display: flex; align-items: center; justify-content: space-between; font-size: 14px; }
        .left-group, .right-group { display: flex; align-items: center; gap: 15px; }
        button.icon-btn { background: none; border: none; color: #ddd; font-size: 18px; cursor: pointer; padding: 5px; transition: color 0.2s; display: flex; align-items: center; justify-content: center; width: 30px; }
        button.icon-btn:hover { color: #fff; transform: scale(1.1); }
        .time-display { font-variant-numeric: tabular-nums; color: #ccc; font-size: 13px; margin-left: 5px; }

        .vol-container { display: flex; align-items: center; gap: 8px; width: 100px; margin-right: 10px; }
        .vol-slider { -webkit-appearance: none; background: rgba(255,255,255,0.2); height: 4px; border-radius: 2px; width: 100%; cursor: pointer; }
        .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%; background: #fff; cursor: pointer; }
        .vol-icon { font-size: 14px; cursor: pointer; width: 20px; text-align: center; }

        #state-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 80px; color: rgba(255,255,255,0.8); pointer-events: none;
            opacity: 0; transition: opacity 0.2s, transform 0.2s; z-index: 50;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #state-overlay.animate { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    </style>
</head>
<body>

    <div id="player-container">
        <div id="top-trigger"></div>
        
        <div id="video-info" class="hidden">
            <!-- è°ƒæ•´é¡ºåºï¼šæ–‡ä»¶åæ”¾åœ¨æœ€ä¸Šé¢ï¼Œä½ç½®æ”¾åœ¨æœ€ä¸‹é¢ -->
            <div class="info-row" id="info-row-filename"><span class="info-label">File</span><span class="info-val" id="info-name">-</span></div>
            <div class="info-row"><span class="info-label">Res</span><span class="info-val" id="info-res">-</span></div>
            <div class="info-row"><span class="info-label">Size</span><span class="info-val" id="info-size">-</span></div>
            <div class="info-row"><span class="info-label">Type</span><span class="info-val" id="info-type">-</span></div>
            
            <!-- å·²ç§»åŠ¨åˆ°æœ€ä¸‹æ–¹ -->
            <div class="info-row"><span class="info-label">Pos</span><span class="info-val" id="info-pos">- / -</span></div>
        </div>

        <video id="video-node"></video>
        <div id="drop-zone">
            <div class="drop-icon">ğŸ¬</div>
            <div class="drop-text">æ‹–å…¥è§†é¢‘æ–‡ä»¶ / æ–‡ä»¶å¤¹</div>
        </div>
        <div id="state-overlay">â–¶</div>

        <div id="top-right-controls">
            <div class="circle-btn" id="btn-fit-mode" title="ç”»é¢å¡«å……">â†”</div>
            <div class="circle-btn" id="btn-immersive" title="æ²‰æµ¸æ¨¡å¼">ğŸ‘</div>
            <div class="circle-btn" id="btn-toggle-list" title="æ’­æ”¾åˆ—è¡¨ (L)">â˜°</div>
            <div class="circle-btn" id="btn-toggle-settings" title="é…ç½® (S)">âš™</div>
        </div>

        <div id="bottom-trigger"></div>

        <div id="controls-bar">
            <div class="progress-row" id="progress-track">
                <div class="progress-bg">
                    <div class="progress-fill" id="progress-fill"></div>
                    <div class="progress-thumb" id="progress-thumb"></div>
                </div>
            </div>

            <div class="buttons-row">
                <div class="left-group">
                    <button class="icon-btn" id="btn-prev" title="ä¸Šä¸€ä¸ª (PageUp)">â®</button>
                    <button class="icon-btn" id="btn-play" title="æ’­æ”¾/æš‚åœ">â–¶</button>
                    <button class="icon-btn" id="btn-next" title="ä¸‹ä¸€ä¸ª (PageDown)">â­</button>
                    <div class="time-display">
                        <span id="time-current">00:00</span> / <span id="time-total">00:00</span>
                    </div>
                </div>

                <div class="right-group">
                    <button class="icon-btn" id="btn-play-mode" title="æ’­æ”¾æ¨¡å¼" style="font-size:16px;">â¡</button>
                    
                    <div class="vol-container">
                        <span class="vol-icon" id="btn-mute">ğŸ”Š</span>
                        <input type="range" id="inp-vol" class="vol-slider" min="0" max="1" step="0.05" value="1">
                    </div>

                    <span id="speed-display" style="font-size:12px; color:#aaa; width:30px; text-align:right;">1.0x</span>
                    <button class="icon-btn" id="btn-fullscreen" title="å…¨å±">â›¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ’­æ”¾åˆ—è¡¨é¢æ¿ -->
    <div id="playlist-panel" class="sidebar-panel">
        <!-- æ‹–æ‹½æ‰‹æŸ„ -->
        <div id="playlist-resizer"></div>

        <div class="sidebar-header">
            <span>åˆ—è¡¨ (<span id="list-count">0</span>)</span>
            <button class="close-btn" id="btn-close-list">âœ•</button>
        </div>
        <ul id="playlist-list"></ul>
        
        <!-- åˆ—è¡¨åº•éƒ¨æ  -->
        <div class="playlist-footer">
            <!-- æ–°å¢ï¼šç¼©ç•¥å›¾æ˜¾ç¤ºå¼€å…³ -->
            <div class="footer-row">
                <span>æ˜¾ç¤ºç¼©ç•¥å›¾</span>
                <label class="switch">
                    <input type="checkbox" id="chk-show-thumbnails" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="footer-row">
                <span>æ˜¾ç¤ºæ–‡ä»¶å</span>
                <label class="switch">
                    <input type="checkbox" id="chk-show-filenames" checked>
                    <span class="slider"></span>
                </label>
                <!-- æ–°å¢ï¼šå®Œæ•´æ–‡ä»¶åå¼€å…³ï¼Œåªæœ‰å½“æ˜¾ç¤ºæ–‡ä»¶åæ‰“å¼€æ—¶æ‰æœ‰æ•ˆ -->
                <span style="margin-left:8px; font-size: 12px; color: #aaa;">å®Œæ•´</span>
                <label class="switch" style="margin-left:4px;">
                    <input type="checkbox" id="chk-show-fullnames">
                    <span class="slider"></span>
                </label>
            </div>
            <!-- æ–°å¢ï¼šç½‘æ ¼æ¨¡å¼å¼€å…³ -->
            <div class="footer-row">
                <span>ç½‘æ ¼æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="chk-grid-mode">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="footer-row">
                <span>æ‹–æ‹½è¿½åŠ æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="chk-append-mode">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settings-panel" class="sidebar-panel">
        <div class="sidebar-header">
            <span>é…ç½®ä¸­å¿ƒ</span>
            <button class="close-btn" id="btn-close-settings">âœ•</button>
        </div>
        <div class="cfg-scroll-area">
            
            <div class="cfg-group">
                <div class="cfg-title">åŸºç¡€è¡Œä¸º</div>
                <div class="cfg-row">
                    <span class="cfg-label">æ–¹å‘é”®å¿«è¿› (ç§’)</span>
                    <input type="number" id="inp-seek-time" class="cfg-num" min="1" max="60">
                </div>
                <div class="cfg-row">
                    <span class="cfg-label">è®°å¿†é…ç½®</span>
                    <label class="switch">
                        <input type="checkbox" id="chk-remember">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="cfg-row">
                    <span class="cfg-label">æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯é¢æ¿</span>
                    <label class="switch">
                        <input type="checkbox" id="chk-show-info">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="cfg-group">
                <details>
                    <summary>å¿«æ·é”®é…ç½® (ç‚¹å‡»ä¿®æ”¹)</summary>
                    <div class="details-content">
                        <div class="cfg-row">
                            <span class="cfg-label">æ’­æ”¾ / æš‚åœ</span>
                            <button class="key-btn" id="key-play" data-action="togglePlay"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">ä¸Šä¸€ä¸ªè§†é¢‘</span>
                            <button class="key-btn" id="key-prev" data-action="playPrev"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">ä¸‹ä¸€ä¸ªè§†é¢‘</span>
                            <button class="key-btn" id="key-next" data-action="playNext"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">å¿«è¿› (å‰è¿›)</span>
                            <button class="key-btn" id="key-forward" data-action="seekForward"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">å¿«é€€ (åé€€)</span>
                            <button class="key-btn" id="key-backward" data-action="seekBackward"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">éŸ³é‡åŠ  (+)</span>
                            <button class="key-btn" id="key-vol-up" data-action="volUp"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">éŸ³é‡å‡ (-)</span>
                            <button class="key-btn" id="key-vol-down" data-action="volDown"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">é€Ÿåº¦ + (0.1x)</span>
                            <button class="key-btn" id="key-speed-up" data-action="speedUp"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">é€Ÿåº¦ - (0.1x)</span>
                            <button class="key-btn" id="key-speed-down" data-action="speedDown"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">å…¨å±åˆ‡æ¢</span>
                            <button class="key-btn" id="key-fullscreen" data-action="toggleFullscreen"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">æ‰“å¼€åˆ—è¡¨</span>
                            <button class="key-btn" id="key-playlist" data-action="togglePlaylist"></button>
                        </div>
                        <div class="cfg-row">
                            <span class="cfg-label">æ˜¾ç¤ºä¿¡æ¯å¼€å…³</span>
                            <button class="key-btn" id="key-info" data-action="toggleInfo"></button>
                        </div>
                        <!-- æ–°å¢ï¼šé™éŸ³åˆ‡æ¢å¿«æ·é”®é…ç½® -->
                        <div class="cfg-row">
                            <span class="cfg-label">é™éŸ³åˆ‡æ¢</span>
                            <button class="key-btn" id="key-mute" data-action="toggleMute"></button>
                        </div>
                    </div>
                </details>
            </div>

            <button class="btn-full-width btn-danger" id="btn-reset-cfg">æ¢å¤é»˜è®¤é…ç½®</button>
            <div style="font-size:12px; color:#666; margin-top:20px; text-align:center;">Ver 11.2 | Thumbnails</div>
        </div>
    </div>

<script>
const DEFAULT_CONFIG = {
    seekStep: 5,
    remember: true,
    showInfo: true,
    sidebarWidth: 340,
    showListNames: true, // æ–°å¢ï¼šä¿å­˜æ˜¯å¦æ˜¾ç¤ºæ–‡ä»¶å
    volume: 1.0,
    muted: false,
    speed: 1.0,
    playMode: 0, 
    fitMode: 0,
    // åˆ—è¡¨ç¼©æ”¾å› å­ï¼Œ1 è¡¨ç¤ºæ­£å¸¸å°ºå¯¸ï¼Œå¯é€šè¿‡ Ctrl+æ»šè½®è°ƒæ•´
    listScale: 1,
    // æ˜¯å¦å¯ç”¨ç½‘æ ¼æ¨¡å¼ï¼›å¼€å¯åå¤šåˆ—æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œè‡ªåŠ¨éšè—æ–‡ä»¶å
    gridMode: false,
    // æ˜¯å¦æ˜¾ç¤ºå®Œæ•´æ–‡ä»¶åï¼Œé»˜è®¤ä¸ºä¸æ˜¾ç¤ºï¼ˆä¼šæˆªæ–­ï¼‰
    showFullNames: false,
    // æ˜¯å¦æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œé»˜è®¤ä¸ºæ˜¾ç¤º
    showThumbnails: true,
    keys: {
        togglePlay: ' ',
        toggleInfo: 'Tab',
        seekForward: 'ArrowRight',
        seekBackward: 'ArrowLeft',
        volUp: 'ArrowUp',
        volDown: 'ArrowDown',
        speedUp: ']',
        speedDown: '[',
        toggleFullscreen: 'f',
        togglePlaylist: 'l',
        playNext: 'PageDown',
        playPrev: 'PageUp',
        // æ–°å¢ï¼šé™éŸ³åˆ‡æ¢å¿«æ·é”®ï¼Œé»˜è®¤ä½¿ç”¨å¤§å†™ M
        toggleMute: 'M'
    }
};

const app = {
    state: {
        playlist: [],
        currentIndex: -1,
        isAppendMode: false,
        isImmersive: false,
        thumbnailQueue: [] // ç•¥ç¼©å›¾ç”Ÿæˆé˜Ÿåˆ—
    },
    
    config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),

    ui: {
        video: document.getElementById('video-node'),
        container: document.getElementById('player-container'),
        dropZone: document.getElementById('drop-zone'),
        stateOverlay: document.getElementById('state-overlay'),
        videoInfo: document.getElementById('video-info'),
        playlistList: document.getElementById('playlist-list'), // æ–°å¢å¼•ç”¨
        
        // Panels
        playlistPanel: document.getElementById('playlist-panel'),
        settingsPanel: document.getElementById('settings-panel'),
        playlistResizer: document.getElementById('playlist-resizer'),
        
        // Controls
        inpVol: document.getElementById('inp-vol'),
        btnMute: document.getElementById('btn-mute'),
        speedDisplay: document.getElementById('speed-display'),

        // Buttons
        btnImmersive: document.getElementById('btn-immersive'),
        btnFitMode: document.getElementById('btn-fit-mode'),
        btnPlayMode: document.getElementById('btn-play-mode'),
        btnToggleList: document.getElementById('btn-toggle-list'),
        btnToggleSettings: document.getElementById('btn-toggle-settings'),
        btnCloseList: document.getElementById('btn-close-list'),
        btnCloseSettings: document.getElementById('btn-close-settings'),
        btnPlay: document.getElementById('btn-play'),
        btnFullscreen: document.getElementById('btn-fullscreen'),
        btnNext: document.getElementById('btn-next'),
        btnPrev: document.getElementById('btn-prev'),
        progressTrack: document.getElementById('progress-track'),
        progressFill: document.getElementById('progress-fill'),
        progressThumb: document.getElementById('progress-thumb'),
        
        // Config Inputs
        inpSeekTime: document.getElementById('inp-seek-time'),
        chkRemember: document.getElementById('chk-remember'),
        chkShowInfo: document.getElementById('chk-show-info'),
        chkShowFilenames: document.getElementById('chk-show-filenames'), // æ–°å¢
        // æ–°å¢ï¼šç¼©ç•¥å›¾æ˜¾ç¤ºå¼€å…³
        chkShowThumbnails: document.getElementById('chk-show-thumbnails'),
        // æ–°å¢ï¼šç½‘æ ¼æ¨¡å¼å¼€å…³
        chkGridMode: document.getElementById('chk-grid-mode'),
        // æ–°å¢ï¼šå®Œæ•´æ–‡ä»¶åå¼€å…³
        chkShowFullnames: document.getElementById('chk-show-fullnames'),
        btnResetCfg: document.getElementById('btn-reset-cfg'),
        keyButtons: document.querySelectorAll('.key-btn'),
        
        // Info Spans
        infoPos: document.getElementById('info-pos'),
        infoName: document.getElementById('info-name'),
        infoRes: document.getElementById('info-res'),
        infoSize: document.getElementById('info-size'),
        infoType: document.getElementById('info-type')
    },
    
    // åå°ç”Ÿæˆç•¥ç¼©å›¾ç”¨çš„è¾…åŠ©å…ƒç´ 
    thumbGen: {
        video: document.createElement('video'),
        canvas: document.createElement('canvas'),
        isProcessing: false
    },

    init() {
        this.loadConfig();
        this.renderConfigToUI();
        this.toggleInfoVisibility();
        this.toggleListNames(); // åˆå§‹åŒ–åˆ—è¡¨æ˜¾ç¤ºçŠ¶æ€
        
        this.ui.playlistPanel.style.width = this.config.sidebarWidth + 'px';
        
        this.ui.video.volume = this.config.volume;
        this.ui.video.muted = this.config.muted;
        this.ui.video.playbackRate = this.config.speed;
        this.ui.inpVol.value = this.config.volume;
        
        this.updateSpeedDisplay();
        this.applyFitMode();
        this.updatePlayModeUI();
        this.updateMuteIcon();
        // åº”ç”¨åˆå§‹åˆ—è¡¨ç¼©æ”¾
        if (typeof this.applyListScale === 'function') {
            this.applyListScale();
        }
        
        // åˆå§‹åŒ–ç•¥ç¼©å›¾ç”Ÿæˆå™¨é…ç½®
        this.thumbGen.video.muted = true;
        this.thumbGen.video.style.display = 'none';
        document.body.appendChild(this.thumbGen.video); // éœ€è¦åœ¨DOMä¸­æ‰èƒ½è§¦å‘æŸäº›åŠ è½½äº‹ä»¶

        this.bindGlobalEvents();
        this.bindVideoEvents();
        this.bindControlEvents();
        this.bindSettingsEvents();
        this.bindResizeEvents();
        if (typeof this.bindZoomEvents === 'function') {
            this.bindZoomEvents();
        }
    },

    loadConfig() {
        const saved = localStorage.getItem('raw_player_config');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (parsed.remember) {
                    this.config = { 
                        ...DEFAULT_CONFIG, 
                        ...parsed, 
                        keys: { ...DEFAULT_CONFIG.keys, ...parsed.keys } 
                    };
                }
            } catch (e) { console.warn("Config load failed", e); }
        }
    },

    saveConfig() {
        if (this.config.remember) {
            this.config.volume = this.ui.video.volume;
            this.config.muted = this.ui.video.muted;
            this.config.speed = this.ui.video.playbackRate;
            // ä¿å­˜åˆ—è¡¨ç¼©æ”¾å› å­
            this.config.listScale = this.config.listScale || DEFAULT_CONFIG.listScale;
            localStorage.setItem('raw_player_config', JSON.stringify(this.config));
        } else {
            localStorage.removeItem('raw_player_config');
        }
    },

    resetConfig() {
        this.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
        this.saveConfig();
        this.renderConfigToUI();
        this.toggleInfoVisibility();
        this.toggleListNames();
        this.ui.playlistPanel.style.width = this.config.sidebarWidth + 'px';
        
        this.ui.video.volume = 1;
        this.ui.video.muted = false;
        this.ui.video.playbackRate = 1.0;
        this.ui.inpVol.value = 1;
        
        this.applyFitMode();
        this.updatePlayModeUI();
        this.updateSpeedDisplay();
        this.updateMuteIcon();
        // æ¢å¤ç¼©æ”¾å› å­ä¸ºé»˜è®¤å€¼å¹¶é‡æ–°åº”ç”¨ç¼©æ”¾
        this.config.listScale = DEFAULT_CONFIG.listScale;
        if (typeof this.applyListScale === 'function') {
            this.applyListScale();
        }
        alert("å·²æ¢å¤é»˜è®¤é…ç½®");
    },
    
    renderConfigToUI() {
        this.ui.inpSeekTime.value = this.config.seekStep;
        this.ui.chkRemember.checked = this.config.remember;
        
        for (let action in this.config.keys) {
            const btn = document.querySelector(`.key-btn[data-action="${action}"]`);
            if (btn) btn.innerText = this.config.keys[action];
        }
        // æ›´æ–°åŸºç¡€é…ç½®å¯¹åº”çš„UIæ§ä»¶çŠ¶æ€
        if (this.ui.chkGridMode) this.ui.chkGridMode.checked = this.config.gridMode;
        if (this.ui.chkShowFilenames) this.ui.chkShowFilenames.checked = this.config.showListNames;
        if (this.ui.chkShowInfo) this.ui.chkShowInfo.checked = this.config.showInfo;
        if (this.ui.chkShowThumbnails) this.ui.chkShowThumbnails.checked = this.config.showThumbnails;

        // è®¾ç½®å®Œæ•´æ–‡ä»¶åå¼€å…³çš„çŠ¶æ€å’Œå¯ç”¨æ€§
        if (this.ui.chkShowFullnames) {
            this.ui.chkShowFullnames.checked = this.config.showFullNames;
            // åªæœ‰å½“æ˜¾ç¤ºæ–‡ä»¶åæ‰“å¼€æ—¶æ‰å…è®¸æ“ä½œå®Œæ•´æ–‡ä»¶åå¼€å…³
            this.ui.chkShowFullnames.disabled = !this.config.showListNames;
        }
    },

    // --- Logic ---

    handleFilesDrop(files) {
        // ä¿®æ”¹ï¼šå¢åŠ åç¼€åæ£€æµ‹ï¼Œè§£å†³éƒ¨åˆ†MKV/AVIæ–‡ä»¶ f.type ä¸ºç©ºå¯¼è‡´æ— æ³•æ‹–å…¥çš„é—®é¢˜
        const videoFiles = Array.from(files).filter(f => {
            return f.type.startsWith('video/') || /\.(mp4|webm|ogg|mov|mkv|avi|m4v|flv|wmv)$/i.test(f.name);
        });
        
        if (videoFiles.length === 0) return;

        videoFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));

        let startIdx = 0;
        if (this.state.isAppendMode && this.state.playlist.length > 0) {
            startIdx = this.state.playlist.length;
            this.state.playlist = this.state.playlist.concat(videoFiles);
            this.appendPlaylistItems(videoFiles, startIdx); // ä»…è¿½åŠ æ¸²æŸ“
        } else {
            this.state.playlist = videoFiles;
            this.state.currentIndex = -1;
            this.renderPlaylistFull(); // é‡æ–°æ¸²æŸ“
            this.playIndex(0);
        }
        this.ui.dropZone.classList.add('hidden');
        document.getElementById('list-count').innerText = this.state.playlist.length;
        
        // è§¦å‘ç•¥ç¼©å›¾ç”Ÿæˆé˜Ÿåˆ—
        this.queueThumbnails(startIdx, videoFiles.length);
    },

    playIndex(index) {
        if (index < 0 || index >= this.state.playlist.length) return;
        this.state.currentIndex = index;
        const file = this.state.playlist[index];
        this.ui.video.src = URL.createObjectURL(file);
        
        this.updatePosDisplay();
        this.ui.infoName.innerText = file.name;
        this.ui.infoSize.innerText = this.formatSize(file.size);
        this.ui.infoType.innerText = file.type || 'unknown'; // å…è®¸ä¸ºç©ºæ—¶æ˜¾ç¤ºunknown
        this.ui.infoRes.innerText = '...';

        this.ui.video.playbackRate = this.config.speed;
        this.ui.video.play().catch(e => console.log("Play interrupted", e));
        this.updatePlaylistHighlight();
        document.title = `â–¶ ${file.name}`;
    },

    updatePosDisplay() {
        const current = this.state.currentIndex + 1;
        const total = this.state.playlist.length;
        const displayCurrent = (this.state.currentIndex >= 0) ? current : '-';
        this.ui.infoPos.innerText = `${displayCurrent} / ${total}`;
    },

    playNext() {
        const len = this.state.playlist.length;
        if (len === 0) return;
        if (this.config.playMode === 3) { 
            this.playIndex(Math.floor(Math.random() * len));
        } else if (this.config.playMode === 1) { 
            this.playIndex((this.state.currentIndex + 1) % len);
        } else { 
            if (this.state.currentIndex < len - 1) this.playIndex(this.state.currentIndex + 1);
        }
    },

    playPrev() {
        const len = this.state.playlist.length;
        if (len === 0) return;
        if (this.config.playMode === 1) { 
            let newIndex = this.state.currentIndex - 1;
            if (newIndex < 0) newIndex = len - 1;
            this.playIndex(newIndex);
        } else if (this.config.playMode === 3) { 
            if (this.state.currentIndex > 0) this.playIndex(this.state.currentIndex - 1);
        } else { 
            if (this.state.currentIndex > 0) this.playIndex(this.state.currentIndex - 1);
        }
    },

    formatSize(bytes) {
        if(bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    togglePlay() {
        if (this.ui.video.paused) {
            this.ui.video.play();
            this.showOverlayIcon('â–¶');
        } else {
            this.ui.video.pause();
            this.showOverlayIcon('â¸');
        }
    },

    seek(seconds) {
        this.ui.video.currentTime += seconds;
        this.showOverlayIcon(seconds > 0 ? 'â©' : 'âª');
    },

    adjustVolume(delta) {
        let v = this.ui.video.volume + delta;
        if (v > 1) v = 1;
        if (v < 0) v = 0;
        this.ui.video.volume = v;
        this.saveConfig();
    },

    adjustSpeed(delta) {
        let newRate = this.ui.video.playbackRate + delta;
        newRate = Math.round(newRate * 10) / 10;
        if (newRate < 0.1) newRate = 0.1;
        if (newRate > 5.0) newRate = 5.0;
        this.ui.video.playbackRate = newRate;
        this.config.speed = newRate; 
        this.updateSpeedDisplay();
        this.showOverlayIcon(`${newRate}x`);
        this.saveConfig();
    },

    updateSpeedDisplay() {
        this.ui.speedDisplay.innerText = this.ui.video.playbackRate + 'x';
    },

    toggleImmersive() {
        this.state.isImmersive = !this.state.isImmersive;
        if (this.state.isImmersive) {
            this.ui.container.classList.add('immersive-active');
            this.ui.btnImmersive.innerText = 'ğŸ”’';
            this.ui.btnImmersive.classList.add('active');
        } else {
            this.ui.container.classList.remove('immersive-active');
            this.ui.btnImmersive.innerText = 'ğŸ‘';
            this.ui.btnImmersive.classList.remove('active');
        }
    },

    toggleFullscreenAction() {
        if(!document.fullscreenElement) this.ui.container.requestFullscreen(); 
        else document.exitFullscreen();
    },

    cycleFitMode() {
        this.config.fitMode = (this.config.fitMode + 1) % 3;
        this.applyFitMode();
        this.saveConfig();
        const icons = ['â†”', 'â¤¢', 'â¬Œ'];
        this.showOverlayIcon(icons[this.config.fitMode]);
    },

    applyFitMode() {
        const modes = ['contain', 'cover', 'fill'];
        this.ui.video.style.objectFit = modes[this.config.fitMode];
        const icons = ['â†”', 'â¤¢', 'â¬Œ'];
        this.ui.btnFitMode.innerText = icons[this.config.fitMode];
    },

    cyclePlayMode() {
        this.config.playMode = (this.config.playMode + 1) % 4;
        this.updatePlayModeUI();
        this.saveConfig();
        const icons = ['â¡', 'ğŸ”', 'ğŸ”‚', 'ğŸ”€'];
        this.showOverlayIcon(icons[this.config.playMode]);
    },

    updatePlayModeUI() {
        const icons = ['â¡', 'ğŸ”', 'ğŸ”‚', 'ğŸ”€'];
        const titles = ['é¡ºåºæ’­æ”¾', 'åˆ—è¡¨å¾ªç¯', 'å•é›†å¾ªç¯', 'éšæœºæ’­æ”¾'];
        this.ui.btnPlayMode.innerText = icons[this.config.playMode];
        this.ui.btnPlayMode.title = `æ’­æ”¾æ¨¡å¼: ${titles[this.config.playMode]}`;
    },

    handleVideoEnded() {
        const len = this.state.playlist.length;
        if (len === 0) return;

        switch(this.config.playMode) {
            case 0: // Sequence
                if (this.state.currentIndex < len - 1) {
                    this.playIndex(this.state.currentIndex + 1);
                } else {
                    this.ui.btnPlay.innerText = "â–¶";
                }
                break;
            case 1: // Loop List
                this.playIndex((this.state.currentIndex + 1) % len);
                break;
            case 2: // Loop One
                this.ui.video.currentTime = 0;
                this.ui.video.play();
                break;
            case 3: // Shuffle
                let nextIndex = Math.floor(Math.random() * len);
                if(len > 1 && nextIndex === this.state.currentIndex) {
                    nextIndex = (nextIndex + 1) % len;
                }
                this.playIndex(nextIndex);
                break;
        }
    },

    toggleInfoVisibility() {
        this.ui.chkShowInfo.checked = this.config.showInfo;
        if (this.config.showInfo) {
            this.ui.videoInfo.classList.remove('hidden');
        } else {
            this.ui.videoInfo.classList.add('hidden');
        }
    },

    // --- æ’­æ”¾åˆ—è¡¨æ¸²æŸ“é€»è¾‘ ---
    
    toggleListNames() {
        if (this.config.showListNames) {
            this.ui.playlistList.classList.remove('hide-filenames');
        } else {
            this.ui.playlistList.classList.add('hide-filenames');
        }
        this.ui.chkShowFilenames.checked = this.config.showListNames;
        // æ›´æ–°å®Œæ•´æ–‡ä»¶åå¼€å…³çš„å¯ç”¨æ€§ï¼ˆä»…åœ¨æ˜¾ç¤ºæ–‡ä»¶åæ—¶æ‰æœ‰æ•ˆï¼‰
        if (this.ui.chkShowFullnames) {
            this.ui.chkShowFullnames.disabled = !this.config.showListNames;
        }
        // æ ¹æ®å½“å‰æ¨¡å¼é‡æ–°åº”ç”¨ç¼©æ”¾
        if (typeof this.applyListScale === 'function') {
            this.applyListScale();
        }
    },

    renderPlaylistFull() {
        this.ui.playlistList.innerHTML = '';
        this.appendPlaylistItems(this.state.playlist, 0);
        // æ¸²æŸ“å®Œæˆååº”ç”¨ç¼©æ”¾
        if (typeof this.applyListScale === 'function') {
            this.applyListScale();
        }
    },

    appendPlaylistItems(files, startIndex) {
        const fragment = document.createDocumentFragment();
        for(let i=0; i<files.length; i++) {
            const actualIndex = startIndex + i;
            const file = this.state.playlist[actualIndex];
            const li = document.createElement('li');
            li.className = 'list-item';
            if (actualIndex === this.state.currentIndex) li.classList.add('active');
            li.onclick = () => this.playIndex(actualIndex);
            
            // ç»“æ„æ›´æ–°ï¼šåŒ…å«ç•¥ç¼©å›¾IMG
            li.innerHTML = `<span class="list-idx">${actualIndex+1}</span>
                            <img class="list-thumb" id="thumb-${actualIndex}" alt="">
                            <div class="list-name" title="${file.name}">${file.name}</div>`;
            fragment.appendChild(li);
        }
        this.ui.playlistList.appendChild(fragment);
        // è¿½åŠ æ¸²æŸ“ååº”ç”¨ç¼©æ”¾
        if (typeof this.applyListScale === 'function') {
            this.applyListScale();
        }
    },

    updatePlaylistHighlight() {
        const items = this.ui.playlistList.children;
        for (let i = 0; i < items.length; i++) {
            if (i === this.state.currentIndex) {
                items[i].classList.add('active');
                items[i].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                items[i].classList.remove('active');
            }
        }
    },

    // --- ç•¥ç¼©å›¾ç”Ÿæˆç³»ç»Ÿ (é˜Ÿåˆ—å¼) ---
    queueThumbnails(startIdx, count) {
        for(let i=0; i<count; i++) {
            this.state.thumbnailQueue.push(startIdx + i);
        }
        this.processThumbnailQueue();
    },

    processThumbnailQueue() {
        if (this.thumbGen.isProcessing || this.state.thumbnailQueue.length === 0) return;

        this.thumbGen.isProcessing = true;
        const idx = this.state.thumbnailQueue.shift();
        const file = this.state.playlist[idx];
        
        // ç¡®ä¿æ–‡ä»¶å’ŒDOMå…ƒç´ è¿˜å­˜åœ¨
        const imgEl = document.getElementById(`thumb-${idx}`);
        if (!file || !imgEl) {
            this.thumbGen.isProcessing = false;
            this.processThumbnailQueue(); // è·³è¿‡å¹¶ç»§ç»­
            return;
        }

        const video = this.thumbGen.video;
        const url = URL.createObjectURL(file);
        
        // ä¸€æ¬¡æ€§äº‹ä»¶å¤„ç†å™¨
        const cleanup = () => {
            URL.revokeObjectURL(url);
            video.onloadeddata = null;
            video.onseeked = null;
            video.onerror = null;
        };

        video.onloadeddata = () => {
            // è§†é¢‘åŠ è½½åï¼Œè·³è½¬åˆ°1ç§’æˆ–è§†é¢‘ä¸­é—´
            video.currentTime = Math.min(1.0, video.duration / 2);
        };

        video.onseeked = () => {
            try {
                // ç»˜åˆ¶åˆ°Canvas
                // æé«˜ç•¥ç¼©å›¾åˆ†è¾¨ç‡ï¼šç”Ÿæˆæ›´é«˜æ¸…æ™°åº¦çš„ç¼©ç•¥å›¾
                // åŸå…ˆä¸º 140x80 (2x)ï¼Œç°åœ¨æå‡è‡³ 320x180 (çº¦ 16:9 æ¯”ä¾‹)
                this.thumbGen.canvas.width = 320;
                this.thumbGen.canvas.height = 180;
                const ctx = this.thumbGen.canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, this.thumbGen.canvas.width, this.thumbGen.canvas.height);
                
                // è¾“å‡ºä¸ºBlobUrlèµ‹å€¼ç»™imgæ ‡ç­¾
                this.thumbGen.canvas.toBlob((blob) => {
                    if(blob) {
                        const thumbUrl = URL.createObjectURL(blob);
                        imgEl.src = thumbUrl;
                        imgEl.onload = () => { /* å¯ä»¥åœ¨è¿™é‡Œé‡Šæ”¾blobï¼Œä½†ä¸ºäº†åˆ—è¡¨æ˜¾ç¤ºæš‚ä¿ç•™ */ };
                    }
                    cleanup();
                    this.thumbGen.isProcessing = false;
                    setTimeout(() => this.processThumbnailQueue(), 50); // ç¨å¾®å»¶è¿Ÿé˜²æ­¢å¡é¡¿
                }, 'image/jpeg', 0.7);
            } catch(e) {
                console.warn("Thumb gen failed", e);
                cleanup();
                this.thumbGen.isProcessing = false;
                this.processThumbnailQueue();
            }
        };

        video.onerror = () => {
            cleanup();
            this.thumbGen.isProcessing = false;
            this.processThumbnailQueue();
        };

        video.src = url;
    },

    showOverlayIcon(text) {
        this.ui.stateOverlay.innerText = text;
        this.ui.stateOverlay.classList.remove('animate');
        void this.ui.stateOverlay.offsetWidth;
        this.ui.stateOverlay.classList.add('animate');
        setTimeout(() => this.ui.stateOverlay.classList.remove('animate'), 500);
    },

    updateMuteIcon() {
        const v = this.ui.video;
        if (v.muted || v.volume === 0) {
            this.ui.btnMute.innerText = 'ğŸ”‡';
        } else if (v.volume < 0.5) {
            this.ui.btnMute.innerText = 'ğŸ”‰';
        } else {
            this.ui.btnMute.innerText = 'ğŸ”Š';
        }
    },

    /**
     * æ ¹æ® listScale ç¼©æ”¾æ’­æ”¾åˆ—è¡¨ä¸­çš„æ¡ç›®å’Œç•¥ç¼©å›¾å°ºå¯¸ã€‚
     * å½“æ˜¾ç¤ºæ–‡ä»¶åæ—¶ç¼©æ”¾åˆ—è¡¨æ¨¡å¼å°ºå¯¸ï¼Œå¦åˆ™ç¼©æ”¾ç½‘æ ¼æ¨¡å¼å°ºå¯¸ã€‚
     */
    applyListScale() {
        const scale = this.config.listScale || 1;
        const gridMode = this.config.gridMode;
        // æ˜¯å¦æ˜¾ç¤ºæ–‡ä»¶åï¼šç½‘æ ¼æ¨¡å¼ä¸‹ä¹Ÿéµå¾ªæ˜¾ç¤ºæ–‡ä»¶åå¼€å…³
        const showNames = this.config.showListNames;
        const fullNames = this.config.showFullNames;
        const showThumbs = this.config.showThumbnails;
        const listEl = this.ui.playlistList;
        const items = listEl.children;

        // è®¾ç½®å®¹å™¨æ ·å¼: ç½‘æ ¼æ¨¡å¼ä¸‹ä½¿ç”¨ flex-wrap ä»¥å½¢æˆå¤šåˆ—
        if (gridMode) {
            listEl.style.display = 'flex';
            listEl.style.flexWrap = 'wrap';
        } else {
            listEl.style.display = '';
            listEl.style.flexWrap = '';
        }

        for (let i = 0; i < items.length; i++) {
            const li = items[i];
            const thumb = li.querySelector('.list-thumb');
            const idx = li.querySelector('.list-idx');
            const name = li.querySelector('.list-name');

            if (gridMode) {
                // ç½‘æ ¼æ¨¡å¼ï¼šå¤šåˆ—æ˜¾ç¤º
                const thumbW = 100 * scale;
                const thumbH = 56 * scale;
                li.style.display = 'flex';
                li.style.flexDirection = 'column';
                li.style.alignItems = 'center';
                li.style.justifyContent = 'flex-start';
                // ç¼©ç•¥å›¾å®½é«˜ï¼›å¦‚æœä¸æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œåˆ™éšè—
                if (thumb) {
                    if (showThumbs) {
                        thumb.style.display = '';
                        thumb.style.width = thumbW + 'px';
                        thumb.style.height = thumbH + 'px';
                    } else {
                        thumb.style.display = 'none';
                    }
                }
                // è®¾å®šå®½åº¦å’Œé—´è·
                li.style.width = (thumbW + 12) + 'px';
                li.style.marginRight = '6px';
                li.style.marginBottom = '6px';
                li.style.borderBottom = 'none';
                // éšè—ç´¢å¼•
                if (idx) idx.style.display = 'none';
                // æ–‡ä»¶åæ˜¾ç¤ºé€»è¾‘
                if (name) {
                    if (showNames) {
                        name.style.display = '';
                        name.style.fontSize = (13 * scale) + 'px';
                        name.style.marginTop = '4px';
                        name.style.width = '100%';
                        name.style.maxWidth = '100%';
                        name.style.textAlign = 'center';
                        if (fullNames) {
                            name.style.whiteSpace = 'normal';
                            name.style.overflow = 'visible';
                            name.style.textOverflow = 'unset';
                            name.style.wordBreak = 'break-all';
                        } else {
                            name.style.whiteSpace = 'nowrap';
                            name.style.overflow = 'hidden';
                            name.style.textOverflow = 'ellipsis';
                            name.style.wordBreak = '';
                        }
                    } else {
                        name.style.display = 'none';
                    }
                }
                li.style.height = 'auto';
            } else {
                // éç½‘æ ¼æ¨¡å¼ï¼šæ ¹æ®æ˜¾ç¤ºè®¾ç½®è°ƒæ•´å¸ƒå±€
                li.style.display = 'flex';
                li.style.flexDirection = '';
                li.style.alignItems = 'center';
                li.style.justifyContent = '';
                li.style.marginRight = '';
                li.style.marginBottom = '';
                li.style.width = '';
                li.style.borderBottom = '';

                // æ˜¾ç¤ºç´¢å¼•é€»è¾‘
                if (idx) {
                    // å½“æ˜¾ç¤ºç¼©ç•¥å›¾æˆ–æ–‡ä»¶åæ—¶æ˜¾ç¤ºç´¢å¼•ï¼›å¦åˆ™åœ¨äº‹ä»¶ä¸­ä¿è¯ä¸ä¼šå‘ç”Ÿéƒ½éšè—
                    idx.style.display = '';
                    idx.style.width = (20 * scale) + 'px';
                    idx.style.fontSize = (12 * scale) + 'px';
                }

                // ç¼©ç•¥å›¾å¤„ç†
                if (thumb) {
                    if (showThumbs) {
                        thumb.style.display = '';
                        // ç¼©ç•¥å›¾å¤§å°æ ¹æ®æ˜¯å¦æ˜¾ç¤ºæ–‡ä»¶åå˜åŒ–
                        if (showNames) {
                            thumb.style.width = (70 * scale) + 'px';
                            thumb.style.height = (40 * scale) + 'px';
                        } else {
                            // æ–‡ä»¶åä¸æ˜¾ç¤ºæ—¶ä½¿ç”¨è¾ƒå¤§ç¼©ç•¥å›¾
                            thumb.style.width = (100 * scale) + 'px';
                            thumb.style.height = (56 * scale) + 'px';
                        }
                        thumb.style.margin = '0 10px';
                    } else {
                        // ä¸æ˜¾ç¤ºç¼©ç•¥å›¾
                        thumb.style.display = 'none';
                        thumb.style.margin = '0';
                    }
                }

                if (showNames) {
                    // æ˜¾ç¤ºæ–‡ä»¶å
                    // æ ¹æ®ç¼©ç•¥å›¾å’Œå®Œæ•´åç§°å†³å®šé«˜åº¦ä¸å†…è¾¹è·
                    if (fullNames) {
                        // å®Œæ•´åç§°æ¨¡å¼è¡Œé«˜æ ¹æ®å†…å®¹è‡ªé€‚åº”
                        li.style.height = 'auto';
                    } else if (!showThumbs) {
                        // æ— ç¼©ç•¥å›¾ä¸”å•è¡Œåç§°æ—¶è®¾ç½®æ›´å°çš„é«˜åº¦ä»¥ä¾¿ç´§å‡‘æ’åˆ—
                        li.style.height = (30 * scale) + 'px';
                    } else {
                        // æœ‰ç¼©ç•¥å›¾æ—¶çš„é»˜è®¤é«˜åº¦
                        li.style.height = (50 * scale) + 'px';
                    }
                    // è°ƒæ•´å†…è¾¹è·ä»¥ç¼©å°è¡Œé—´è·ï¼ˆæ— ç¼©ç•¥å›¾æ—¶å‡å°å†…è¾¹è·ï¼‰
                    if (!showThumbs) {
                        li.style.padding = '4px 10px';
                    } else {
                        // æ¢å¤é»˜è®¤å†…è¾¹è·
                        li.style.padding = '';
                    }
                    if (name) {
                        name.style.display = '';
                        name.style.fontSize = (13 * scale) + 'px';
                        if (fullNames) {
                            name.style.whiteSpace = 'normal';
                            name.style.overflow = 'visible';
                            name.style.textOverflow = 'unset';
                            name.style.wordBreak = 'break-all';
                        } else {
                            name.style.whiteSpace = 'nowrap';
                            name.style.overflow = 'hidden';
                            name.style.textOverflow = 'ellipsis';
                            name.style.wordBreak = '';
                        }
                    }
                } else {
                    // ä¸æ˜¾ç¤ºæ–‡ä»¶å
                    if (name) name.style.display = 'none';
                    // éšè—ç´¢å¼•
                    if (idx) idx.style.display = 'none';
                    if (showThumbs) {
                        // åç§°ä¸æ˜¾ç¤ºä½†æœ‰ç¼©ç•¥å›¾ï¼Œå¤§å›¾æ¨¡å¼
                        li.style.height = (70 * scale) + 'px';
                    } else {
                        // åç§°å’Œç¼©ç•¥å›¾éƒ½ä¸æ˜¾ç¤ºçš„æƒ…å†µä¸ä¼šå‘ç”Ÿï¼Œç”±äº‹ä»¶é€»è¾‘é¿å…
                        li.style.height = '40px';
                    }
                }
            }
        }
    },

    /**
     * ç»‘å®š Ctrl + æ»šè½® ç¼©æ”¾åˆ—è¡¨çš„äº‹ä»¶ã€‚é¼ æ ‡ä½äºæ’­æ”¾åˆ—è¡¨åŒºåŸŸæ—¶æŒ‰ä½ Ctrl è°ƒæ•´ç¼©æ”¾å› å­ã€‚
     */
    bindZoomEvents() {
        const listEl = this.ui.playlistList;
        if (!listEl) return;
        listEl.addEventListener('wheel', (e) => {
            // ä»…å½“æŒ‰ä½ Ctrl é”®æ—¶è§¦å‘ç¼©æ”¾
            if (!e.ctrlKey) return;
            e.preventDefault();
            // e.deltaY > 0 è¡¨ç¤ºå‘ä¸‹æ»šåŠ¨ï¼Œç¼©å°ï¼›<0 è¡¨ç¤ºå‘ä¸Šæ»šåŠ¨ï¼Œæ”¾å¤§
            const step = 0.1;
            if (e.deltaY > 0) {
                this.config.listScale = Math.max(0.5, (this.config.listScale || 1) - step);
            } else if (e.deltaY < 0) {
                this.config.listScale = Math.min(3.0, (this.config.listScale || 1) + step);
            }
            this.applyListScale();
            this.saveConfig();
        }, { passive: false });
    },

    // --- Events ---

    bindGlobalEvents() {
        // ä¿®æ”¹ï¼šå¢åŠ  dropEffect ä»¥è·å¾—æ›´å¥½çš„é¼ æ ‡åé¦ˆï¼Œç¡®ä¿æ‹–æ‹½ç”Ÿæ•ˆ
        document.body.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });
        
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            this.handleFilesDrop(e.dataTransfer.files);
        });

        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            if (document.querySelector('.key-btn.recording')) return;

            if (this.state.playlist.length === 0 && e.key !== 'l') return;

            const key = e.key;
            const map = this.config.keys;

            if (key === map.toggleInfo) {
                e.preventDefault();
                this.config.showInfo = !this.config.showInfo;
                this.toggleInfoVisibility();
                this.saveConfig();
            }
            else if (key === map.togglePlay) { e.preventDefault(); this.togglePlay(); }
            else if (key === map.seekForward) { this.seek(this.config.seekStep); }
            else if (key === map.seekBackward) { this.seek(-this.config.seekStep); }
            else if (key === map.volUp) { e.preventDefault(); this.adjustVolume(0.1); }
            else if (key === map.volDown) { e.preventDefault(); this.adjustVolume(-0.1); }
            // æ–°å¢ï¼šé”®ç›˜é™éŸ³/å–æ¶ˆé™éŸ³åˆ‡æ¢
            else if (map.toggleMute && key.toLowerCase() === map.toggleMute.toLowerCase()) {
                e.preventDefault();
                this.ui.video.muted = !this.ui.video.muted;
                this.saveConfig();
            }
            else if (key === map.speedUp) { this.adjustSpeed(0.1); }
            else if (key === map.speedDown) { this.adjustSpeed(-0.1); }
            else if (key === map.playNext) { this.playNext(); } 
            else if (key === map.playPrev) { this.playPrev(); } 
            else if (key.toLowerCase() === map.toggleFullscreen.toLowerCase()) { 
                this.toggleFullscreenAction();
            }
            else if (key.toLowerCase() === map.togglePlaylist.toLowerCase()) {
                this.ui.playlistPanel.classList.toggle('open');
                this.ui.settingsPanel.classList.remove('open');
            }
        });
    },

    bindVideoEvents() {
        const v = this.ui.video;
        v.addEventListener('dblclick', () => this.toggleFullscreenAction());
        v.addEventListener('timeupdate', () => {
            const pct = (v.currentTime / v.duration) * 100 || 0;
            this.ui.progressFill.style.width = `${pct}%`;
            this.ui.progressThumb.style.left = `${pct}%`;
            document.getElementById('time-current').innerText = this.formatTime(v.currentTime);
        });
        v.addEventListener('loadedmetadata', () => {
            document.getElementById('time-total').innerText = this.formatTime(v.duration);
            this.ui.infoRes.innerText = `${v.videoWidth}x${v.videoHeight}`;
        });
        v.addEventListener('ended', () => this.handleVideoEnded());
        v.addEventListener('play', () => this.ui.btnPlay.innerText = "â¸");
        v.addEventListener('pause', () => this.ui.btnPlay.innerText = "â–¶");
        v.addEventListener('click', () => this.togglePlay());
        
        v.addEventListener('volumechange', () => {
            this.ui.inpVol.value = v.volume;
            this.updateMuteIcon();
        });
        v.addEventListener('ratechange', () => {
            this.updateSpeedDisplay();
        });
    },

    bindControlEvents() {
        this.ui.btnPlay.onclick = () => this.togglePlay();
        this.ui.btnImmersive.onclick = () => this.toggleImmersive();
        this.ui.btnFitMode.onclick = () => this.cycleFitMode();
        this.ui.btnPlayMode.onclick = () => this.cyclePlayMode();
        
        this.ui.btnToggleList.onclick = () => {
            this.ui.playlistPanel.classList.toggle('open');
            this.ui.settingsPanel.classList.remove('open');
        };
        this.ui.btnCloseList.onclick = () => this.ui.playlistPanel.classList.remove('open');
        
        this.ui.btnToggleSettings.onclick = () => {
            this.ui.settingsPanel.classList.toggle('open');
            this.ui.playlistPanel.classList.remove('open');
        };
        this.ui.btnCloseSettings.onclick = () => this.ui.settingsPanel.classList.remove('open');

        this.ui.inpVol.addEventListener('input', (e) => {
            this.ui.video.volume = e.target.value;
            this.saveConfig();
        });
        this.ui.btnMute.onclick = () => {
            this.ui.video.muted = !this.ui.video.muted;
            this.saveConfig();
        };

        let isDragging = false;
        const handleDrag = (e) => {
            const rect = this.ui.progressTrack.getBoundingClientRect();
            let x = e.clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            const pct = x / rect.width;
            if (this.ui.video.duration) this.ui.video.currentTime = this.ui.video.duration * pct;
        };
        this.ui.progressTrack.addEventListener('mousedown', (e) => { isDragging = true; handleDrag(e); });
        document.addEventListener('mousemove', (e) => { if (isDragging) handleDrag(e); });
        document.addEventListener('mouseup', () => isDragging = false);

        this.ui.btnNext.onclick = () => this.playNext();
        this.ui.btnPrev.onclick = () => this.playPrev();
        this.ui.btnFullscreen.onclick = () => this.toggleFullscreenAction();
        document.getElementById('chk-append-mode').onchange = (e) => this.state.isAppendMode = e.target.checked;
        

        // æ–°å¢ï¼šåˆ‡æ¢æ–‡ä»¶åæ˜¾ç¤º
        this.ui.chkShowFilenames.onchange = (e) => {
            this.config.showListNames = e.target.checked;
            // å¦‚æœå°è¯•å…³é—­æ–‡ä»¶åæ˜¾ç¤ºä¸”ç¼©ç•¥å›¾åŒæ—¶å…³é—­ï¼Œåˆ™è‡ªåŠ¨å¯ç”¨ç¼©ç•¥å›¾
            if (!this.config.showListNames && !this.config.showThumbnails) {
                this.config.showThumbnails = true;
                if (this.ui.chkShowThumbnails) this.ui.chkShowThumbnails.checked = true;
            }
            this.toggleListNames();
            // é‡æ–°åº”ç”¨ç¼©æ”¾å¸ƒå±€ï¼ˆåŒ…æ‹¬ç¼©ç•¥å›¾éšè—ä¸å¦ï¼‰
            if (typeof this.applyListScale === 'function') {
                this.applyListScale();
            }
            this.saveConfig();
        };

        // æ–°å¢ï¼šåˆ‡æ¢å®Œæ•´æ–‡ä»¶åæ˜¾ç¤º
        if (this.ui.chkShowFullnames) {
            this.ui.chkShowFullnames.onchange = (e) => {
                this.config.showFullNames = e.target.checked;
                // åº”ç”¨å®Œæ•´åç§°æ˜¾ç¤ºåé‡æ–°å¸ƒå±€
                if (typeof this.applyListScale === 'function') {
                    this.applyListScale();
                }
                this.saveConfig();
            };
        }
        // æ–°å¢ï¼šåˆ‡æ¢ç¼©ç•¥å›¾æ˜¾ç¤º
        if (this.ui.chkShowThumbnails) {
            this.ui.chkShowThumbnails.onchange = (e) => {
                this.config.showThumbnails = e.target.checked;
                // å¦‚æœå°è¯•å…³é—­ç¼©ç•¥å›¾ä¸”æ–‡ä»¶åä¹Ÿå…³é—­ï¼Œåˆ™è‡ªåŠ¨å¯ç”¨æ–‡ä»¶å
                if (!this.config.showThumbnails && !this.config.showListNames) {
                    this.config.showListNames = true;
                    if (this.ui.chkShowFilenames) this.ui.chkShowFilenames.checked = true;
                    // æ›´æ–°æ–‡ä»¶åå¼€å…³å¯ç”¨æ€§
                    this.toggleListNames();
                }
                // é‡æ–°åº”ç”¨å¸ƒå±€
                if (typeof this.applyListScale === 'function') {
                    this.applyListScale();
                }
                this.saveConfig();
            };
        }

        // æ–°å¢ï¼šåˆ‡æ¢ç½‘æ ¼æ¨¡å¼
        this.ui.chkGridMode.onchange = (e) => {
            this.config.gridMode = e.target.checked;
            // å¯ç”¨æˆ–å…³é—­ç½‘æ ¼æ¨¡å¼åé‡æ–°åº”ç”¨ç¼©æ”¾å’Œå¸ƒå±€
            if (typeof this.applyListScale === 'function') {
                this.applyListScale();
            }
            this.saveConfig();
        };
    },

    bindSettingsEvents() {
        this.ui.inpSeekTime.onchange = (e) => {
            let val = parseInt(e.target.value);
            if(val < 1) val = 1;
            this.config.seekStep = val;
            this.saveConfig();
        };
        this.ui.chkRemember.onchange = (e) => {
            this.config.remember = e.target.checked;
            this.saveConfig();
        };
        this.ui.chkShowInfo.onchange = (e) => {
            this.config.showInfo = e.target.checked;
            this.toggleInfoVisibility();
            this.saveConfig();
        };

        this.ui.btnResetCfg.onclick = () => this.resetConfig();

        this.ui.keyButtons.forEach(btn => {
            btn.onclick = () => {
                const action = btn.dataset.action;
                const oldText = btn.innerText;
                btn.innerText = "...";
                btn.classList.add('recording');
                
                const handler = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) return;
                    const newKey = e.key;
                    this.config.keys[action] = newKey;
                    btn.innerText = newKey;
                    btn.classList.remove('recording');
                    this.saveConfig();
                    document.removeEventListener('keydown', handler, true);
                };
                document.addEventListener('keydown', handler, true);
            };
        });
    },

    bindResizeEvents() {
        let isResizing = false;
        
        this.ui.playlistResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            let newWidth = window.innerWidth - e.clientX;
            if (newWidth < 200) newWidth = 200;
            if (newWidth > window.innerWidth * 0.8) newWidth = window.innerWidth * 0.8;
            this.ui.playlistPanel.style.width = newWidth + 'px';
            this.config.sidebarWidth = newWidth;
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                this.saveConfig();
            }
        });
    },

    formatTime(s) {
        if (!s || isNaN(s)) return "00:00";
        const m = Math.floor(s / 60);
        const sc = Math.floor(s % 60);
        return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
    }
};

app.init();
</script>
</body>
</html>