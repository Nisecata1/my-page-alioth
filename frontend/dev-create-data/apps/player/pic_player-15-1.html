<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebP æ’­æ”¾å™¨ v21 (é¢„åŠ è½½å¢å¼ºç‰ˆ)</title>
    <style>
        /* --- å…¨å±€ --- */
        body { margin: 0; background: #050505; color: #fff; height: 100vh; overflow: hidden; font-family: "Segoe UI", sans-serif; user-select: none; display: flex; }
        
        /* --- ä¸»ç”»é¢ --- */
        #main-area { flex: 1; position: relative; height: 100%; background: #000; overflow: hidden; cursor: default; }
        
        .viewer-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; opacity: 0; 
            transform-origin: center center;
            will-change: transform, opacity;
            cursor: grab; 
        }
        .viewer-layer.active { opacity: 1; z-index: 10; }
        .viewer-layer.grabbing { cursor: grabbing; }

        .fit-contain { object-fit: contain; }
        .fit-cover { object-fit: cover; }
        .fit-none { object-fit: none; }

        /* --- é¡¶éƒ¨è§¦å‘åŒº & æ§åˆ¶æ  --- */
        #top-trigger-zone { position: fixed; top: 0; left: 0; right: 0; height: 80px; z-index: 150; }
        #controls-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 200;
            display: flex; gap: 15px; align-items: center;
            background: rgba(20, 20, 20, 0.9); padding: 10px 25px; border-radius: 50px;
            border: 1px solid #444; backdrop-filter: blur(10px);
            transition: transform 0.3s, opacity 0.3s;
        }
        #controls-container.hidden-mode { transform: translate(-50%, -150%); opacity: 0; pointer-events: none; }
        #top-trigger-zone:hover ~ #controls-container, #controls-container:hover { transform: translate(-50%, 0); opacity: 1; pointer-events: auto; }

        button.ctrl-btn { background: transparent; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 20px; transition: 0.2s; }
        button.ctrl-btn:hover { color: #4CAF50; transform: scale(1.1); }
        button.active-btn { color: #4CAF50; }

        /* --- å³ä¸Šè§’åŠŸèƒ½é”® --- */
        #top-right-controls { 
            position: fixed; top: 20px; right: 20px; z-index: 200; 
            display: flex; gap: 10px; transition: opacity 0.3s; 
        }
        .circle-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #666; color: #fff;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s;
        }
        .circle-btn:hover { background: #4CAF50; border-color: #4CAF50; transform: scale(1.1); }
        .hidden-mode-active #top-right-controls { opacity: 0; pointer-events: none; }
        #top-trigger-zone:hover ~ #top-right-controls, #top-right-controls:hover { opacity: 1; pointer-events: auto; }

        /* --- å·¦ä¸Šè§’å…ƒæ•°æ® --- */
        #meta-info {
            position: fixed; top: 0; left: 0; z-index: 100;
            background: rgba(0, 0, 0, 0.7); padding: 8px 12px; 
            border-bottom-right-radius: 8px; pointer-events: none; display: none; 
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.2s;
        }
        .meta-row { display: block; font-size: 12px; color: #ddd; text-shadow: 1px 1px 2px #000; line-height: 1.5; white-space: nowrap; }
        .meta-index { color: #4CAF50; font-weight: bold; font-size: 14px; }
        .meta-val { color: #ccc; max-width: 350px; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: bottom;}
        .meta-label { color: #888; margin-right: 5px; font-size: 11px; }

        /* --- ä¾§è¾¹æ é€šç”¨ --- */
        .sidebar-panel {
            position: fixed; top: 0; bottom: 0; width: 320px;
            background: rgba(30, 30, 30, 0.98); border-left: 1px solid #444;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; z-index: 300; 
            box-shadow: -5px 0 20px rgba(0,0,0,0.8);
            right: 0; transform: translateX(100%); 
        }
        .sidebar-panel.open { transform: translateX(0); }
        .sidebar-header { padding: 0 15px; height: 40px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: bold; color: #fff; flex-shrink: 0; background: #252525; }
        .close-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        .close-btn:hover { color: #fff; }

        /* --- æ‹–æ‹½è°ƒæ•´å¤§å°çš„æ‰‹æŸ„ --- */
        #playlist-resize-handle {
            position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: transparent; cursor: ew-resize; z-index: 310;
        }
        #playlist-resize-handle:hover, #playlist-resize-handle.resizing {
            background: #4CAF50; box-shadow: 0 0 10px #4CAF50;
        }

        /* é…ç½®æ æ ·å¼ */
        .cfg-group { padding: 20px; border-bottom: 1px solid #333; }
        .cfg-title { font-size: 12px; color: #4CAF50; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .cfg-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cfg-label { font-size: 14px; color: #ddd; }
        input[type="number"] { width: 50px; background: #222; border: 1px solid #555; color: #fff; padding: 4px; border-radius: 4px; text-align: center; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(20px); }

        .cfg-footer { padding: 20px; font-size: 12px; color: #666; text-align: center; margin-top: auto; border-top: 1px solid #333; line-height: 1.5; }
        .reset-btn { width: 100%; background: #333; color: #ddd; border: 1px solid #555; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .reset-btn:hover { background: #444; color: #fff; border-color: #888; }

        details { width: 100%; }
        summary { cursor: pointer; color: #4CAF50; font-size: 13px; font-weight: bold; outline: none; list-style: none; display: flex; align-items: center; justify-content: space-between; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: "â–¼"; font-size: 10px; transition: transform 0.2s; }
        details[open] summary::after { transform: rotate(180deg); }
        .details-content { margin-top: 15px; padding-left: 5px; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .key-btn { background: #222; border: 1px solid #444; color: #fff; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-family: monospace; min-width: 60px; text-align: center; }
        .key-btn:hover { border-color: #888; background: #333; }
        .key-btn.recording { background: #4CAF50; border-color: #4CAF50; color: #000; animation: pulse 1s infinite; }

        /* --- å¿«æ·é”®å®¹å™¨ä¸æ ‡ç­¾æ ·å¼ --- */
        .key-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }
        .key-badge {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            position: relative;
            display: flex;
            align-items: center;
        }
        .key-badge:hover {
            border-color: #888;
            background: #333;
        }
        .key-badge.recording {
            background: #4CAF50;
            border-color: #4CAF50;
            color: #000;
            animation: pulse 1s infinite;
        }
        .key-delete {
            margin-left: 4px;
            cursor: pointer;
            color: #888;
            font-size: 14px;
            line-height: 1;
            user-select: none;
        }
        .key-delete:hover {
            color: #f44336;
        }
        .key-add {
            background: #333;
            border: 1px dashed #666;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
        }
        .key-add:hover {
            color: #fff;
            border-color: #888;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- ç´§å‡‘ç”»å»Šåˆ—è¡¨ (v20) --- */
        #playlist-list { 
            flex: 1; overflow-y: auto; padding: 5px; margin: 0; list-style: none; 
            /* å¯†é›†ç½‘æ ¼ */
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 2px; /* æå°çš„é—´éš™ */
            justify-content: center;

            --thumb-size: 100px; 
        }
        
        .list-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            width: var(--thumb-size); 
            /* æ—  Paddingï¼Œæ—  Marginï¼Œæè‡´ç´§å‡‘ */
            border-radius: 0;
            position: relative;
            box-sizing: border-box;
            border: 2px solid transparent; /* é¢„ç•™è¾¹æ¡†ä½ç½® */
            transition: transform 0.1s;
        }
        
        /* é€‰ä¸­çŠ¶æ€ï¼šä½¿ç”¨å†…æè¾¹ï¼Œä¸å½±å“å¸ƒå±€ */
        .list-item.active { 
            border-color: #4CAF50; 
            z-index: 2; /* æµ®èµ· */
        }
        
        .thumb-box { 
            width: 100%; 
            height: var(--thumb-size); /* æ­£æ–¹å½¢ */
            background: #111; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden;
        }
        
        .thumb-canvas, .thumb-img { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            display: block; /* å»é™¤ inline é—´éš™ */
        }
        
        .file-name-list { 
            font-size: 11px; color: #aaa; background: #222;
            width: 100%; text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
            padding: 2px 0;
        }

        #playlist-list.hide-text .file-name-list { display: none; }

        /* --- è¿ç»­ç¿»é¡µå®¹å™¨æ ·å¼ --- */
        /* è¦†ç›–ä¸»ç”»é¢çš„æ¨ªå‘è¿ç»­ç¿»é¡µå®¹å™¨ï¼Œé»˜è®¤éšè— */
        #continuous-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            display: none;
            background: #000;
        }
        #continuous-strip {
            display: flex;
            height: 100%;
        }
        /* å•ä¸ªå›¾ç‰‡é«˜åº¦å æ»¡å®¹å™¨ï¼Œé«˜å®½æ¯”è‡ªé€‚åº” */
        .continuous-img {
            height: 100%;
            object-fit: contain;
            /* é»˜è®¤å®Œå…¨å¯è§ï¼Œæ·¡å…¥æ·¡å‡ºæ•ˆæœåœ¨åŠ è½½æ—¶è®¾ç½® */
            opacity: 1;
            transition: none;
        }
        /* å®šåˆ¶è¿ç»­æ¨¡å¼æ»šåŠ¨æ¡æ ·å¼ */
        #continuous-container::-webkit-scrollbar {
            height: 8px;
        }
        #continuous-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        #continuous-container::-webkit-scrollbar-track {
            background: #111;
        }
        
        /* --- åˆ—è¡¨åº•éƒ¨å·¥å…·æ  (v20) --- */
        .playlist-footer { 
            position: relative;
            background: #1a1a1a; 
            border-top: 1px solid #333; 
            flex-shrink: 0;
        }

        /* åº•éƒ¨å¸¸é©»æ¡ */
        .footer-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 15px; height: 30px;
        }
        .footer-info { font-size: 11px; color: #666; }
        .footer-btn { 
            background: #333; border: 1px solid #555; color: #ddd; 
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; gap: 5px;
        }
        .footer-btn:hover { background: #444; border-color: #888; color: #fff; }
        .footer-btn.active { background: #1b5e20; border-color: #4CAF50; }

        /* å¼¹å‡ºèœå• */
        #list-options-menu {
            position: absolute; bottom: 100%; left: 0; right: 0;
            background: rgba(35, 35, 35, 0.98);
            border-top: 1px solid #444;
            padding: 15px;
            transform: translateY(100%); opacity: 0; pointer-events: none;
            transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.2s;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
            z-index: 20;
        }
        #list-options-menu.visible {
            transform: translateY(0); opacity: 1; pointer-events: auto;
        }

        #drop-zone { border: 3px dashed #555; padding: 80px; text-align: center; color: #888; border-radius: 20px; position: absolute; pointer-events: none; top: 50%; left: 50%; transform: translate(-50%,-50%); }
    </style>
</head>
<body id="body-root">

    <div id="top-trigger-zone"></div>

    <div id="meta-info">
        <div class="meta-row" id="meta-row-index"><span class="meta-index" id="val-index">0 / 0</span></div>
        <div class="meta-row" id="meta-row-name"><span class="meta-val" id="val-name">filename.webp</span></div>
        <div class="meta-row" id="meta-row-size"><span class="meta-label">SIZE:</span><span class="meta-val" id="val-size">0 KB</span></div>
        <div class="meta-row" id="meta-row-date"><span class="meta-label">DATE:</span><span class="meta-val" id="val-date">2026/01/01</span></div>
    </div>

    <div id="main-area">
        <div id="drop-zone">
            <h1>ğŸ“‚ æ‹–å…¥æ–‡ä»¶å¤¹</h1>
            <p>Ctrl+A å…¨é€‰ WebP/IMG æ‹–å…¥<br><br><small style="color:#555">v21: ç‹¬ç«‹é¢„åŠ è½½è®¾ç½®</small></p>
        </div>
        <img id="layer-a" class="viewer-layer fit-contain" src="">
        <img id="layer-b" class="viewer-layer fit-contain" src="">
        <!-- è¿ç»­ç¿»é¡µå®¹å™¨ï¼ŒåŒ…å«æ¨ªå‘æ’åˆ—çš„å›¾ç‰‡ -->
        <div id="continuous-container">
            <div id="continuous-strip"></div>
        </div>
    </div>

    <div id="controls-container">
        <button class="ctrl-btn" id="btn-hide-mode" title="æ²‰æµ¸æ¨¡å¼">ğŸ‘</button>
        <div style="width: 1px; height: 20px; background: #555;"></div>
        <button class="ctrl-btn" id="btn-prev">â®</button>
        <button class="ctrl-btn" id="btn-play">â–¶</button>
        <button class="ctrl-btn" id="btn-next">â­</button>
        <div style="width: 1px; height: 20px; background: #555;"></div>
        <span style="font-size: 12px; color: #aaa;">é—´éš”:</span>
        <input type="number" id="interval-input" value="3" step="0.5" style="width:35px; background:#333; color:#fff; border:none; text-align:center;">
    </div>

    <!-- v21: è°ƒæ•´æŒ‰é’®é¡ºåºï¼Œè®¾ç½®(S)ç§»è‡³æœ€å³ -->
    <div id="top-right-controls">
        <div class="circle-btn" id="btn-fullscreen" title="å…¨å± (F)">â›¶</div>
        <div class="circle-btn" id="btn-scale" title="å¡«å……æ¨¡å¼ (Click)">â†”</div>
        <div class="circle-btn" id="btn-toggle-list" title="åˆ—è¡¨ (L)">â˜°</div>
        <div class="circle-btn" id="btn-settings" title="é…ç½® (S)">âš™</div>
    </div>

    <div id="settings-panel" class="sidebar-panel">
        <div class="sidebar-header">
            <span>é…ç½®ä¸­å¿ƒ</span>
            <button class="close-btn" id="btn-close-settings">âœ•</button>
        </div>
        
        <div class="cfg-group" style="background: rgba(76, 175, 80, 0.1);">
            <div class="cfg-title" style="color:#81c784">ç³»ç»Ÿ</div>
            <div class="cfg-row">
                <label class="cfg-label">è®°ä½æ‰€æœ‰é…ç½®</label>
                <label class="switch">
                    <input type="checkbox" id="cfg-remember">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="cfg-group">
            <details>
                <summary>å¿«æ·é”®é…ç½® (å±•å¼€)</summary>
                <div class="details-content">
                    <div class="cfg-row"><label class="cfg-label">æ‰“å¼€/å…³é—­åˆ—è¡¨</label><div class="key-container" id="key-toggleList-container"></div></div>
                    <div class="cfg-row"><label class="cfg-label">å…¨å±åˆ‡æ¢</label><div class="key-container" id="key-fullscreen-container"></div></div>
                    <div class="cfg-row"><label class="cfg-label">æ‰“å¼€é…ç½®</label><div class="key-container" id="key-settings-container"></div></div>
                    <div class="cfg-row"><label class="cfg-label">æ˜¾éšä¿¡æ¯å¼€å…³</label><div class="key-container" id="key-info-container"></div></div>
                    <!-- æ–°å¢ï¼šä¸Šä¸€å¼ /ä¸‹ä¸€å¼ å¿«æ·é”®é…ç½® -->
                    <div class="cfg-row"><label class="cfg-label">ä¸Šä¸€å¼ </label><div class="key-container" id="key-prev-container"></div></div>
                    <div class="cfg-row"><label class="cfg-label">ä¸‹ä¸€å¼ </label><div class="key-container" id="key-next-container"></div></div>
                </div>
            </details>
        </div>

        <!-- v22: æ–°å¢ç¿»é¡µè®¾ç½® -->
        <div class="cfg-group">
            <div class="cfg-title">ç¿»é¡µè®¾ç½®</div>
            <div class="cfg-row">
                <label class="cfg-label">ç¿»é¡µæ¨¡å¼</label>
                <select id="cfg-flip-mode" style="background:#222; color:#fff; border:1px solid #555; padding:4px; border-radius:4px;">
                    <option value="single">å•é¡µç¿»é¡µ</option>
                    <option value="continuous">å·¦â†’å³è¿ç»­ç¿»é¡µ</option>
                </select>
            </div>
        </div>

        <!-- v21: ç‹¬ç«‹é¢„åŠ è½½è®¾ç½® -->
        <div class="cfg-group">
            <div class="cfg-title">æ€§èƒ½ & æ¸²æŸ“</div>
            <div class="cfg-row">
                <label class="cfg-label">é¢„åŠ è½½ (åä¸€å¼ /Next)</label>
                <input type="number" id="cfg-preload-next" min="1" max="50">
            </div>
            <div class="cfg-row">
                <label class="cfg-label">é¢„åŠ è½½ (å‰ä¸€å¼ /Prev)</label>
                <input type="number" id="cfg-preload-prev" min="0" max="50">
            </div>
            <div class="cfg-row">
                <label class="cfg-label">å¹³æ»‘æ·¡å…¥æ·¡å‡º (ä»…å•é¡µç”Ÿæ•ˆ)</label>
                <label class="switch"><input type="checkbox" id="cfg-fade"><span class="slider"></span></label>
            </div>
            <div class="cfg-row">
                <label class="cfg-label">è¿‡æ¸¡æ—¶é•¿ (ç§’)</label>
                <input type="number" id="cfg-fade-duration" step="0.05" min="0.1" max="5.0">
            </div>
        </div>
        
        <div class="cfg-group">
            <div class="cfg-title">å·¦ä¸Šè§’ä¿¡æ¯æ˜¾ç¤º</div>
            <div class="cfg-row">
                <label class="cfg-label">æ˜¾ç¤ºé¡µç  (Index)</label>
                <label class="switch"><input type="checkbox" id="cfg-show-index"><span class="slider"></span></label>
            </div>
            <div class="cfg-row">
                <label class="cfg-label">æ˜¾ç¤ºæ–‡ä»¶å (Name)</label>
                <label class="switch"><input type="checkbox" id="cfg-show-name"><span class="slider"></span></label>
            </div>
            <div class="cfg-row">
                <label class="cfg-label">æ˜¾ç¤ºæ–‡ä»¶å¤§å° (Size)</label>
                <label class="switch"><input type="checkbox" id="cfg-show-size"><span class="slider"></span></label>
            </div>
            <div class="cfg-row">
                <label class="cfg-label">æ˜¾ç¤ºä¿®æ”¹æ—¶é—´ (Date)</label>
                <label class="switch"><input type="checkbox" id="cfg-show-date"><span class="slider"></span></label>
            </div>
        </div>

        <div class="cfg-footer">
            <div style="font-weight:bold; margin-bottom:5px;">WebP Player v21</div>
            <button class="reset-btn" id="btn-reset-cfg">â†º æ¢å¤é»˜è®¤é…ç½®</button>
        </div>
    </div>

    <!-- v20: åˆ—è¡¨é¢æ¿ -->
    <div id="playlist-panel" class="sidebar-panel">
        <!-- æ‹–æ‹½æ‰‹æŸ„ -->
        <div id="playlist-resize-handle"></div>

        <div class="sidebar-header">
            <span>ç”»å»Š (<span id="list-count">0</span>)</span>
            <button class="close-btn" id="btn-close-list">âœ•</button>
        </div>
        
        <!-- åˆ—è¡¨å®¹å™¨ -->
        <ul id="playlist-list" class="hide-text"></ul>

        <!-- åº•éƒ¨å·¥å…·æ  -->
        <div class="playlist-footer">
            <!-- å¼¹å‡ºèœå• -->
            <div id="list-options-menu">
                <div class="cfg-row" style="margin:0">
                    <label class="cfg-label">æ˜¾ç¤ºæ–‡ä»¶å</label>
                    <label class="switch"><input type="checkbox" id="btn-show-filenames"><span class="slider"></span></label>
                </div>
                <div class="cfg-row" style="margin:0">
                    <label class="cfg-label">åŠ¨æ€å°å›¾ (GIF/WebP)</label>
                    <label class="switch"><input type="checkbox" id="btn-dynamic-thumbs"><span class="slider"></span></label>
                </div>
                <div class="cfg-row" style="margin:0">
                    <label class="cfg-label">æ‹–æ‹½è¿½åŠ æ¨¡å¼</label>
                    <label class="switch"><input type="checkbox" id="btn-append-mode"><span class="slider"></span></label>
                </div>
            </div>

            <!-- å¸¸é©»æ¡ -->
            <div class="footer-bar">
                <!-- æ–°å¢ç¼©ç•¥å›¾å°ºå¯¸æ»‘å— -->
                <input type="range" id="thumb-size-range" min="50" max="500" step="10" value="100" title="ç¼©ç•¥å›¾å°ºå¯¸" style="width:200px; margin-right:8px;">
                <span class="footer-info">Ctrl+æ»šè½®ç¼©æ”¾ | æ‹–æ‹½æ‰©å®½</span>
                <button class="footer-btn" id="btn-toggle-list-opts">âš™ è®¾ç½®</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = {
            preloadNext: 3, // é»˜è®¤å‘åé¢„åŠ è½½3å¼ 
            preloadPrev: 1, // é»˜è®¤å‘å‰é¢„åŠ è½½1å¼ 
            enableFade: false,
            fadeDuration: 0.15,
            showIndex: true, showName: false, showSize: false, showDate: false,
            remember: false,
            showListNames: false,
            useDynamicThumbs: false,
            thumbSize: 100, 
            listWidth: 320, 
            // é»˜è®¤å¿«æ·é”®æ˜ å°„ã€‚æ”¯æŒå¤šä¸ªæŒ‰é”®ï¼Œä»¥æ•°ç»„å½¢å¼å­˜å‚¨ã€‚å½“ä¸ºå­—ç¬¦ä¸²æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºå•å…ƒç´ æ•°ç»„ã€‚
            keyMap: { toggleList: 'l', fullscreen: 'f', settings: 's', info: 'Tab', prev: 'ArrowLeft', next: 'ArrowRight' }
            ,
            // ç¿»é¡µæ¨¡å¼ï¼š'single' è¡¨ç¤ºå•é¡µç¿»é¡µï¼Œ'continuous' è¡¨ç¤ºä»å·¦åˆ°å³è¿ç»­ç¿»é¡µï¼ˆé¢„ç•™ï¼‰
            pageMode: 'single'
        };
        
        let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

        const layerA = document.getElementById('layer-a');
        const layerB = document.getElementById('layer-b');
        const playlistList = document.getElementById('playlist-list');
        const settingsPanel = document.getElementById('settings-panel');
        const playlistPanel = document.getElementById('playlist-panel');
        const metaInfo = document.getElementById('meta-info');
        const mainArea = document.getElementById('main-area');
        // è¿ç»­ç¿»é¡µå®¹å™¨å’Œå†…å±‚å…ƒç´ 
        const continuousContainer = document.getElementById('continuous-container');
        const continuousStrip = document.getElementById('continuous-strip');
        
        let fileList = [];
        let currentIndex = 0;
        let isPlaying = false;
        let playTimer = null;
        let scaleMode = 0;
        let isHiddenMode = false;
        let activeLayer = 0;
        let isAppendMode = false;
        let globalInfoVisible = true;
        
        // ç¼©æ”¾ç›¸å…³
        let currentZoom = 1.0; let panX = 0; let panY = 0; 
        let isDragging = false; let dragStartX = 0; let dragStartY = 0;
        // è¿ç»­æ¨¡å¼æ‹–æ‹½èµ·å§‹æ»šåŠ¨ä½ç½®
        let startScrollLeft = 0;
        // è¿ç»­æ¨¡å¼çš„ img å…ƒç´ æ•°ç»„åŠå…¶åŠ è½½çŠ¶æ€
        let continuousImgEls = [];
        // æ ‡è®°æ¯ä¸ªç´¢å¼•çš„åŠ è½½çŠ¶æ€ï¼ˆtrue è¡¨ç¤ºå·²åŠ è½½ srcï¼‰
        let loadedFlags = [];
        // å­˜å‚¨æ¯ä¸ªå›¾åƒçš„å®½é«˜æ¯”ï¼ˆå®½/é«˜ï¼‰ï¼Œç”¨äºå›ºå®šå®½åº¦
        let ratioList = [];
        // æ ‡è®°æœ€è¿‘æ˜¯å¦è¿›è¡Œè¿‡æ‹–æ‹½ï¼Œç”¨äºé˜»æ­¢æ‹–æ‹½åè§¦å‘çš„ç‚¹å‡»
        let justDragged = false;

        // è¿ç»­æ¨¡å¼è™šæ‹ŸåŒ–ï¼šè®°å½•ä¸Šä¸€æ¬¡åŠ è½½çš„èŒƒå›´
        let lastLoadStart = 0;
        let lastLoadEnd = -1;

        function init() {
            loadConfig(); 
            syncUI();     
            bindEvents(); 
            bindDragEvents(); 
            bindSidebarResize();
            applyLayerTransition();
            applyListStyles(); 
            updateMetadataUI();

            // åº”ç”¨ç¿»é¡µæ¨¡å¼
            applyPageMode();
        }

        function loadConfig() {
            const saved = localStorage.getItem('webp_player_v20_cfg');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // å…¼å®¹æ—§é…ç½®ï¼šå¦‚æœæœ‰ preloadCount ä½†æ²¡æœ‰ preloadNextï¼Œåˆ™è¿ç§»
                    if (parsed.preloadCount !== undefined && parsed.preloadNext === undefined) {
                        parsed.preloadNext = parsed.preloadCount;
                        parsed.preloadPrev = 1; // é»˜è®¤
                    }
                    config = { ...DEFAULT_CONFIG, ...parsed, keyMap: { ...DEFAULT_CONFIG.keyMap, ...(parsed.keyMap || {}) } };
                } catch (e) { console.error("Config load failed", e); }
            }
        }

        function saveConfig() {
            if (config.remember) localStorage.setItem('webp_player_v20_cfg', JSON.stringify(config));
            else localStorage.removeItem('webp_player_v20_cfg');
        }

        function resetConfig() {
            config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
            saveConfig();
            syncUI();
            applyLayerTransition();
            applyListStyles();
            updateMetadataUI();
            renderPlaylist(true);
            // é‡ç½®ååº”ç”¨ç¿»é¡µæ¨¡å¼
            applyPageMode();
        }

        function syncUI() {
            // ç³»ç»Ÿä¸æ¸²æŸ“ - v21
            document.getElementById('cfg-preload-next').value = config.preloadNext;
            document.getElementById('cfg-preload-prev').value = config.preloadPrev;
            
            document.getElementById('cfg-fade').checked = config.enableFade;
            document.getElementById('cfg-fade-duration').value = config.fadeDuration;
            document.getElementById('cfg-remember').checked = config.remember;
            
            // ä¿¡æ¯é¢æ¿
            document.getElementById('cfg-show-index').checked = config.showIndex;
            document.getElementById('cfg-show-name').checked = config.showName;
            document.getElementById('cfg-show-size').checked = config.showSize;
            document.getElementById('cfg-show-date').checked = config.showDate;
            
            // åˆ—è¡¨é¢æ¿
            document.getElementById('btn-show-filenames').checked = config.showListNames;
            document.getElementById('btn-dynamic-thumbs').checked = config.useDynamicThumbs;

            // ç¿»é¡µæ¨¡å¼
            const flipSel = document.getElementById('cfg-flip-mode');
            if (flipSel) flipSel.value = config.pageMode || 'single';

            // ç¼©ç•¥å›¾å°ºå¯¸æ»‘å—
            const thumbRange = document.getElementById('thumb-size-range');
            if (thumbRange) thumbRange.value = config.thumbSize;
            
            // å¿«æ·é”® UIï¼šç¡®ä¿é…ç½®ä¸ºæ•°ç»„å¹¶é‡å»º UI
            ensureKeyMapArrays();
            buildAllKeyUI();
        }

        function applyListStyles() {
            playlistList.style.setProperty('--thumb-size', `${config.thumbSize}px`);
            playlistPanel.style.width = `${config.listWidth}px`;
            
            if (config.showListNames) playlistList.classList.remove('hide-text');
            else playlistList.classList.add('hide-text');
        }

        /**
         * ç¡®ä¿ keyMap ä¸­æ¯ä¸ªå±æ€§éƒ½æ˜¯æ•°ç»„ã€‚
         * å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå•å…ƒç´ æ•°ç»„ï¼Œç©ºæˆ–æœªå®šä¹‰çš„è½¬æ¢ä¸ºç©ºæ•°ç»„ã€‚
         */
        function ensureKeyMapArrays() {
            const keys = ['toggleList', 'fullscreen', 'settings', 'info', 'prev', 'next'];
            keys.forEach(k => {
                let val = config.keyMap[k];
                if (val === undefined || val === null) {
                    config.keyMap[k] = [];
                } else if (Array.isArray(val)) {
                    // å»é™¤é‡å¤å€¼å¹¶æ ‡å‡†åŒ–å¤§å°å†™
                    const seen = new Set();
                    const arr = [];
                    val.forEach(v => {
                        const low = String(v).toLowerCase();
                        if (!seen.has(low)) {
                            seen.add(low);
                            arr.push(v);
                        }
                    });
                    config.keyMap[k] = arr;
                } else {
                    config.keyMap[k] = [val];
                }
            });
        }

        /**
         * åˆ›å»ºå¹¶æ˜¾ç¤ºç‰¹å®šå¿«æ·é”®é¡¹çš„ UIã€‚
         * @param {string} action æ“ä½œåï¼Œä¾‹å¦‚ 'toggleList'
         */
        function buildKeyUI(action) {
            const container = document.getElementById(`key-${action}-container`);
            if (!container) return;
            // æ¸…ç©ºå½“å‰å†…å®¹
            container.innerHTML = '';
            const arr = config.keyMap[action] || [];
            // æ¸²æŸ“æ¯ä¸ªå·²é…ç½®çš„å¿«æ·é”®
            arr.forEach((keyVal, idx) => {
                const badge = document.createElement('span');
                badge.className = 'key-badge';
                badge.innerText = String(keyVal).toUpperCase();
                badge.title = 'ç‚¹å‡»ä¿®æ”¹';
                badge.onclick = () => startEditKey(action, idx, badge);

                // åˆ é™¤æŒ‰é’®
                const del = document.createElement('span');
                del.className = 'key-delete';
                del.innerText = 'âœ•';
                del.title = 'åˆ é™¤æ­¤å¿«æ·é”®';
                del.onclick = (e) => {
                    e.stopPropagation();
                    deleteKey(action, idx);
                };

                badge.appendChild(del);
                container.appendChild(badge);
            });
            // æ·»åŠ æŒ‰é’®
            const addBtn = document.createElement('span');
            addBtn.className = 'key-add';
            addBtn.innerText = '+';
            addBtn.title = 'æ·»åŠ å¿«æ·é”®';
            addBtn.onclick = () => startAddKey(action, addBtn);
            container.appendChild(addBtn);
        }

        /**
         * é‡å»ºæ‰€æœ‰å¿«æ·é”®é…ç½®è¡Œçš„ UIã€‚
         */
        function buildAllKeyUI() {
            ['toggleList', 'fullscreen', 'settings', 'info', 'prev', 'next'].forEach(buildKeyUI);
        }

        /**
         * ç‚¹å‡»â€œæ·»åŠ å¿«æ·é”®â€æ—¶è°ƒç”¨ï¼Œè¿›å…¥å½•åˆ¶çŠ¶æ€ã€‚
         * @param {string} action æ“ä½œå
         * @param {HTMLElement} btn è§¦å‘å½•åˆ¶çš„å…ƒç´ 
         */
        function startAddKey(action, btn) {
            // å¦‚æœå·²ç»åœ¨å½•åˆ¶ï¼Œå¿½ç•¥
            if (document.querySelector('.key-badge.recording') || document.querySelector('.key-add.recording')) return;
            btn.innerText = '...';
            btn.classList.add('recording');
            const handler = (e) => {
                if (['Control','Alt','Shift','Meta'].includes(e.key)) return;
                e.preventDefault();
                // é¿å…é‡å¤æ·»åŠ ç›¸åŒé”®
                const arr = config.keyMap[action];
                const low = String(e.key).toLowerCase();
                const exists = arr.some(v => String(v).toLowerCase() === low);
                if (!exists) {
                    arr.push(e.key);
                    saveConfig();
                }
                btn.classList.remove('recording');
                buildKeyUI(action);
                document.removeEventListener('keydown', handler, true);
            };
            document.addEventListener('keydown', handler, true);
        }

        /**
         * ç‚¹å‡»å·²æœ‰å¿«æ·é”®æ—¶è°ƒç”¨ï¼Œå…è®¸æ›¿æ¢è¯¥é”®ã€‚
         * @param {string} action æ“ä½œå
         * @param {number} index æ›¿æ¢çš„ä¸‹æ ‡
         * @param {HTMLElement} badge å¾½æ ‡å…ƒç´ 
         */
        function startEditKey(action, index, badge) {
            // å¦‚æœå·²ç»åœ¨å½•åˆ¶ï¼Œå¿½ç•¥
            if (document.querySelector('.key-badge.recording') || document.querySelector('.key-add.recording')) return;
            badge.innerText = '...';
            badge.classList.add('recording');
            const handler = (e) => {
                if (['Control','Alt','Shift','Meta'].includes(e.key)) return;
                e.preventDefault();
                let arr = config.keyMap[action];
                const low = String(e.key).toLowerCase();
                // æŸ¥æ‰¾é™¤ index ä¹‹å¤–çš„é‡å¤é”®
                const existsIdx = arr.findIndex((v, i) => String(v).toLowerCase() === low && i !== index);
                if (existsIdx !== -1) {
                    arr.splice(existsIdx, 1);
                    if (index > existsIdx) index--;
                }
                arr[index] = e.key;
                saveConfig();
                badge.classList.remove('recording');
                buildKeyUI(action);
                document.removeEventListener('keydown', handler, true);
            };
            document.addEventListener('keydown', handler, true);
        }

        /**
         * åˆ é™¤æŒ‡å®šæ“ä½œçš„æŸä¸ªå¿«æ·é”®ã€‚
         * @param {string} action æ“ä½œå
         * @param {number} index è¦åˆ é™¤çš„é”®ç´¢å¼•
         */
        function deleteKey(action, index) {
            const arr = config.keyMap[action];
            if (!Array.isArray(arr)) return;
            arr.splice(index, 1);
            saveConfig();
            buildKeyUI(action);
        }

        /**
         * æ ¹æ®é…ç½®åº”ç”¨ç¿»é¡µæ¨¡å¼ã€‚å½“å‰å ä½å®ç°ï¼Œä¸æ”¹å˜è¡Œä¸ºã€‚
         * å½“ pageMode ä¸º 'single' æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„å•é¡µç¿»é¡µé€»è¾‘ï¼›
         * å½“ pageMode ä¸º 'continuous' æ—¶ï¼Œé¢„ç•™è¿ç»­ç¿»é¡µé€»è¾‘ã€‚
         */
        function applyPageMode() {
            if (config.pageMode === 'continuous') {
                // è¿›å…¥è¿ç»­æ¨¡å¼ï¼šéšè—å•é¡µå›¾å±‚ä½†ä¿æŒå›¾åƒæ•°æ®ï¼Œä»¥ä¾¿è¿”å›å•é¡µæ—¶ç«‹å³æ˜¾ç¤º
                layerA.style.visibility = 'hidden';
                layerB.style.visibility = 'hidden';
                // æ˜¾ç¤ºæ¨ªå‘å®¹å™¨
                continuousContainer.style.display = 'block';
                // æ¸²æŸ“è¿ç»­å ä½å¹¶å®šä½åˆ°å½“å‰ç´¢å¼•
                renderContinuous();
                if (fileList.length > 0) {
                    scrollToIndex(currentIndex);
                    updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                    updatePlaylistHighlight();
                    updateLoadedImages();
                }
            } else {
                // è¿”å›å•é¡µæ¨¡å¼ï¼šæ˜¾ç¤ºå•é¡µå›¾å±‚ï¼Œéšè—è¿ç»­å®¹å™¨
                continuousContainer.style.display = 'none';
                layerA.style.visibility = '';
                layerB.style.visibility = '';
                // åœ¨å•é¡µæ¨¡å¼ä¸­ä½¿ç”¨æ­£å¸¸çš„åŠ è½½é€»è¾‘ï¼ˆåŒå±‚æ·¡å…¥æ·¡å‡ºï¼‰ã€‚
                // ä¸ºé¿å…é»‘å±ï¼Œç¡®ä¿æ—§å›¾å±‚åœ¨æ–°å›¾åƒåŠ è½½å®Œæˆå‰ä¾ç„¶å¯è§
                if (fileList.length > 0) {
                    loadCurrent();
                }
            }
        }

        function bindSidebarResize() {
            const handle = document.getElementById('playlist-resize-handle');
            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                handle.classList.add('resizing');
                document.body.style.cursor = 'ew-resize';
                e.preventDefault();
            });

            window.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                let newWidth = window.innerWidth - e.clientX;
                if (newWidth < 200) newWidth = 200;
                if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;
                config.listWidth = newWidth;
                playlistPanel.style.width = `${newWidth}px`;
            });

            const stopResize = () => {
                if(isResizing) {
                    isResizing = false;
                    handle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    saveConfig();
                }
            };
            window.addEventListener('mouseup', stopResize);
        }

        function bindEvents() {
            const bindCheck = (id, prop, callback) => {
                document.getElementById(id).onchange = (e) => { 
                    config[prop] = e.target.checked; 
                    if(callback) callback(); 
                    saveConfig(); 
                    // å¤±å»ç„¦ç‚¹ï¼Œé¿å…åˆ‡æ¢åå·¦å³é”®ç„¦ç‚¹ä»åœ¨æ­¤æ§ä»¶å¯¼è‡´ç¿»é¡µå¿«æ·é”®å¤±æ•ˆ
                    if (e.target && typeof e.target.blur === 'function') {
                        e.target.blur();
                    }
                };
            };
            
            // v21: åˆ†åˆ«ç»‘å®š Next å’Œ Prev é¢„åŠ è½½
            document.getElementById('cfg-preload-next').onchange = (e) => {
                config.preloadNext = parseInt(e.target.value) || 3;
                saveConfig();
                // æ›´æ–°è¿ç»­æ¨¡å¼ä¸‹çš„åŠ è½½èŒƒå›´
                if (config.pageMode === 'continuous') updateLoadedImages();
            };
            document.getElementById('cfg-preload-prev').onchange = (e) => {
                config.preloadPrev = parseInt(e.target.value) || 0;
                saveConfig();
                if (config.pageMode === 'continuous') updateLoadedImages();
            };

            bindCheck('cfg-fade', 'enableFade', applyLayerTransition);
            document.getElementById('cfg-fade-duration').onchange = (e) => { 
                config.fadeDuration = Math.max(0.1, parseFloat(e.target.value)); 
                applyLayerTransition(); saveConfig(); 
            };
            
            bindCheck('cfg-show-index', 'showIndex', updateMetadataUI);
            bindCheck('cfg-show-name', 'showName', updateMetadataUI);
            bindCheck('cfg-show-size', 'showSize', updateMetadataUI);
            bindCheck('cfg-show-date', 'showDate', updateMetadataUI);
            bindCheck('cfg-remember', 'remember');

            bindCheck('btn-show-filenames', 'showListNames', applyListStyles);
            bindCheck('btn-dynamic-thumbs', 'useDynamicThumbs', () => renderPlaylist(true));
            document.getElementById('btn-append-mode').onchange = (e) => isAppendMode = e.target.checked;

            // v20: åˆ—è¡¨åº•éƒ¨èœå•å¼€å…³
            const btnListOpts = document.getElementById('btn-toggle-list-opts');
            const menuListOpts = document.getElementById('list-options-menu');
            btnListOpts.onclick = () => {
                btnListOpts.classList.toggle('active');
                menuListOpts.classList.toggle('visible');
            };

            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!btnListOpts.contains(e.target) && !menuListOpts.contains(e.target)) {
                    btnListOpts.classList.remove('active');
                    menuListOpts.classList.remove('visible');
                }
            });

            // æ—§å¿«æ·é”®æŒ‰é’®ç»‘å®šé€»è¾‘å·²ç§»é™¤ï¼Œç”±æ–°çš„ buildKeyUI æœºåˆ¶æ›¿ä»£

            document.getElementById('btn-reset-cfg').onclick = resetConfig;

            playlistPanel.addEventListener('wheel', (e) => {
                if (!e.ctrlKey) return;
                e.preventDefault();
                e.stopPropagation();
                const delta = e.deltaY > 0 ? -10 : 10;
                let newSize = config.thumbSize + delta;
                if (newSize < 50) newSize = 50;
                if (newSize > 500) newSize = 500;
                config.thumbSize = newSize;
                // æ›´æ–°æ»‘å—æ˜¾ç¤ºå€¼ï¼Œä¿æŒåŒæ­¥
                const range = document.getElementById('thumb-size-range');
                if (range) range.value = config.thumbSize;
                applyListStyles();
                saveConfig();
            }, { passive: false });

            // ç¼©ç•¥å›¾å°ºå¯¸æ»‘å—äº‹ä»¶
            const thumbRange = document.getElementById('thumb-size-range');
            if (thumbRange) {
                thumbRange.oninput = (e) => {
                    const v = parseInt(e.target.value);
                    if (!isNaN(v)) {
                        config.thumbSize = v;
                        applyListStyles();
                        saveConfig();
                    }
                };
            }

            // ç¿»é¡µæ¨¡å¼ä¸‹æ‹‰èœå•
            const flipSel = document.getElementById('cfg-flip-mode');
            if (flipSel) {
                // å½“ä¸‹æ‹‰é€‰é¡¹æ”¹å˜æ—¶ç«‹å³åº”ç”¨æ¨¡å¼
                const applyFlip = (val) => {
                    if (val !== config.pageMode) {
                        config.pageMode = val;
                        saveConfig();
                        applyPageMode();
                    }
                };
                flipSel.addEventListener('change', (e) => {
                    applyFlip(e.target.value);
                    // é€‰æ‹©åç«‹å³ç§»é™¤ç„¦ç‚¹ï¼Œé¿å…å·¦å³ç®­å¤´å½±å“ä¸‹æ‹‰æ¡†
                    e.target.blur();
                });
                // æŸäº›æµè§ˆå™¨åœ¨é€‰æ‹©åæœªè§¦å‘ changeï¼Œç›‘å¬ input ä¿åº•
                flipSel.addEventListener('input', (e) => {
                    applyFlip(e.target.value);
                    e.target.blur();
                });
                // é˜»æ­¢å·¦å³ç®­å¤´åœ¨ä¸‹æ‹‰æ¡†å†…å†’æ³¡ï¼Œä»¥å…è§¦å‘å…¨å±€ç¿»é¡µ
                flipSel.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.stopPropagation();
                    }
                });
            }

            // ç‚¹å‡»ç”»å»Šé¢æ¿éé¡¹ç›®åŒºåŸŸå¿«é€Ÿè·³è½¬æ»šåŠ¨ä½ç½®
            playlistPanel.addEventListener('click', (e) => {
                // è·å–åˆ—è¡¨åŒºåŸŸçš„è¾¹ç•Œ
                const listRect = playlistList.getBoundingClientRect();
                // åªå¤„ç†ç‚¹å‡»åœ¨åˆ—è¡¨å†…éƒ¨ï¼ˆä¸å«é¡¶éƒ¨æ ‡é¢˜ã€åº•éƒ¨å·¥å…·æ ï¼‰
                if (e.clientY < listRect.top || e.clientY > listRect.bottom) return;
                // å¦‚æœç‚¹å‡»äº†åˆ—è¡¨é¡¹æˆ–å…¶å­å…ƒç´ ï¼Œä¸æ‰§è¡Œè·³è½¬
                if (e.target.closest('.list-item')) return;
                const ratio = (e.clientY - listRect.top) / listRect.height;
                const maxScroll = playlistList.scrollHeight - playlistList.clientHeight;
                playlistList.scrollTop = ratio * maxScroll;
            });

            // åœ¨è¿ç»­ç¿»é¡µæ¨¡å¼ä¸‹ï¼Œæ»šåŠ¨å®¹å™¨æ—¶æ›´æ–°å½“å‰ç´¢å¼•å’Œé¢„åŠ è½½
            continuousContainer.addEventListener('scroll', () => {
                if (config.pageMode === 'continuous') {
                    updateCurrentIndexFromScroll();
                }
            });
        }

        // --- æ’­æ”¾é€»è¾‘ ---
        function applyLayerTransition() {
            const t = config.enableFade ? `opacity ${config.fadeDuration}s ease` : "none";
            layerA.style.transition = t; layerB.style.transition = t;
        }

        function loadCurrent() {
            if (fileList.length === 0) return;
            resetZoom();
            const file = fileList[currentIndex];
            updateMetadataData(currentIndex + 1, fileList.length, file);

            const url = URL.createObjectURL(file);
            const currentImg = activeLayer === 0 ? layerA : layerB;
            const nextImg = activeLayer === 0 ? layerB : layerA;

            nextImg.src = url;
            nextImg.onload = () => {
                nextImg.classList.add('active');
                currentImg.classList.remove('active');
                activeLayer = 1 - activeLayer;
                doPreload(); // è§¦å‘æ–°çš„é¢„åŠ è½½é€»è¾‘
            };
            updatePlaylistHighlight();
        }

        /**
         * ç›´æ¥åœ¨å•é¡µæ¨¡å¼æ˜¾ç¤ºå½“å‰ç´¢å¼•çš„å›¾ç‰‡ï¼Œä¸ä½¿ç”¨åŒå±‚æ·¡å…¥æ·¡å‡ºã€‚ç”¨äºä»è¿ç»­æ¨¡å¼åˆ‡æ¢å›å•é¡µæ¨¡å¼æ—¶é‡ç½®çŠ¶æ€ã€‚
         */
        function showSingleCurrent() {
            if (fileList.length === 0) return;
            resetZoom();
            const file = fileList[currentIndex];
            updateMetadataData(currentIndex + 1, fileList.length, file);
            // æš‚æ—¶ç¦ç”¨è¿‡æ¸¡
            const prevTA = layerA.style.transition;
            const prevTB = layerB.style.transition;
            layerA.style.transition = 'none';
            layerB.style.transition = 'none';
            // åŠ è½½å›¾ç‰‡åˆ° layerA
            const url = URL.createObjectURL(file);
            layerA.onload = () => {
                // æ¢å¤è¿‡æ¸¡
                applyLayerTransition();
                URL.revokeObjectURL(url);
                // è®¾ç½®å±‚æ¬¡å…³ç³»
                layerA.classList.add('active');
                layerB.classList.remove('active');
                activeLayer = 0;
                updatePlaylistHighlight();
                doPreload();
            };
            layerA.src = url;
        }

        // --- å˜æ¢ç³»ç»Ÿ ---
        function resetZoom() { currentZoom = 1.0; panX = 0; panY = 0; updateZoomTransform(); }
        function updateZoomTransform() {
            const t = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
            layerA.style.transform = t; layerB.style.transform = t;
        }
        mainArea.addEventListener('wheel', (e) => {
            // è¿ç»­æ¨¡å¼ï¼šæ»šè½®æ§åˆ¶æ°´å¹³æ»šåŠ¨ï¼›Ctrl+æ»šè½®ä»ç”¨äºç¼©æ”¾
            if (config.pageMode === 'continuous') {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const d = -e.deltaY * 0.001;
                    currentZoom = Math.min(Math.max(0.1, currentZoom + d), 10);
                    updateZoomTransform();
                } else {
                    e.preventDefault();
                    // æ»šè½®å‘ä¸‹æ—¶å‘å³æ»šåŠ¨ï¼Œå‘ä¸Šæ—¶å‘å·¦æ»šåŠ¨
                    continuousContainer.scrollLeft += e.deltaY;
                    // æ›´æ–°å½“å‰ç´¢å¼•ï¼Œä½¿å…ƒæ•°æ®ä¸åˆ—è¡¨åŒæ­¥
                    updateCurrentIndexFromScroll();
                }
                return;
            }
            // å•é¡µæ¨¡å¼ï¼šCtrl+æ»šè½®ç”¨äºç¼©æ”¾
            if (e.ctrlKey) {
                e.preventDefault();
                const d = -e.deltaY * 0.001;
                currentZoom = Math.min(Math.max(0.1, currentZoom + d), 10);
                updateZoomTransform();
                return;
            }
            // æ™®é€šæ»šè½®ç”¨äºç¿»é¡µï¼ˆä¸Šä¸‹æ»šåŠ¨å¯¹åº”å·¦å³åˆ‡æ¢ï¼‰
            e.preventDefault();
            if (e.deltaY > 0) {
                nextImage();
            } else if (e.deltaY < 0) {
                prevImage();
            }
        }, { passive: false });

        function bindDragEvents() {
            mainArea.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                e.preventDefault();
                isDragging = true;
                if (config.pageMode === 'continuous') {
                    // åœ¨è¿ç»­æ¨¡å¼ä¸‹ï¼Œæ‹–æ‹½ç”¨äºæ»šåŠ¨å®¹å™¨
                    dragStartX = e.clientX;
                    startScrollLeft = continuousContainer.scrollLeft;
                    mainArea.classList.add('grabbing');
                    // æ ‡è®°æ‹–æ‹½å¼€å§‹ï¼Œé˜²æ­¢é‡Šæ”¾æ—¶è§¦å‘çš„ click è¢«è¯†åˆ«
                    justDragged = true;
                } else {
                    // å•é¡µæ¨¡å¼ä¸‹æ‹–æ‹½ç”¨äºå¹³ç§»ç¼©æ”¾è§†å›¾
                    dragStartX = e.clientX - panX;
                    dragStartY = e.clientY - panY;
                    layerA.classList.add('grabbing');
                    layerB.classList.add('grabbing');
                }
            });
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                if (config.pageMode === 'continuous') {
                    const dx = e.clientX - dragStartX;
                    continuousContainer.scrollLeft = startScrollLeft - dx;
                    updateCurrentIndexFromScroll();
                } else {
                    panX = e.clientX - dragStartX;
                    panY = e.clientY - dragStartY;
                    updateZoomTransform();
                }
            });
            const stop = () => {
                if (!isDragging) return;
                isDragging = false;
                if (config.pageMode === 'continuous') {
                    mainArea.classList.remove('grabbing');
                    // æ‹–æ‹½ç»“æŸåç¨åé‡ç½® justDraggedï¼Œé˜²æ­¢ç‚¹å‡»å¸é™„
                    setTimeout(() => { justDragged = false; }, 100);
                } else {
                    layerA.classList.remove('grabbing');
                    layerB.classList.remove('grabbing');
                }
            };
            window.addEventListener('mouseup', stop);
            window.addEventListener('mouseleave', stop);
        }

        // --- å…ƒæ•°æ® ---
        function formatBytes(b) { if(b===0)return '0 B'; const i=Math.floor(Math.log(b)/Math.log(1024)); return parseFloat((b/Math.pow(1024,i)).toFixed(2))+' '+['B','KB','MB','GB'][i]; }
        function updateMetadataData(idx, total, file) {
            document.getElementById('val-index').innerText = `${idx} / ${total}`;
            document.getElementById('val-name').innerText = file.name;
            document.getElementById('val-size').innerText = formatBytes(file.size);
            document.getElementById('val-date').innerText = new Date(file.lastModified).toLocaleString('zh-CN',{hour12:false});
            metaInfo.style.display = 'block'; updateMetadataUI();
        }
        function updateMetadataUI() {
            const set = (id, s) => document.getElementById(id).style.display = s ? 'block' : 'none';
            set('meta-row-index', config.showIndex); set('meta-row-name', config.showName);
            set('meta-row-size', config.showSize); set('meta-row-date', config.showDate);
            const show = globalInfoVisible && (config.showIndex||config.showName||config.showSize||config.showDate);
            metaInfo.style.opacity = show ? 1 : 0;
        }

        // v21: æ›´æ–°çš„åŒå‘é¢„åŠ è½½
        function doPreload() {
            // åœ¨è¿ç»­æ¨¡å¼ä¸­ç”±è™šæ‹ŸåŒ–é€»è¾‘æ§åˆ¶åŠ è½½èŒƒå›´ï¼Œä¸å†é¢å¤–é¢„åŠ è½½
            if (config.pageMode === 'continuous' || fileList.length === 0) {
                return;
            }
            // é¢„åŠ è½½åæ–¹ (Next)
            if(config.preloadNext > 0) {
                for(let i=1; i<=config.preloadNext; i++) {
                    const idx = (currentIndex + i) % fileList.length;
                    const img = new Image();
                    img.src = URL.createObjectURL(fileList[idx]);
                }
            }
            // é¢„åŠ è½½å‰æ–¹ (Prev)
            if(config.preloadPrev > 0) {
                for(let i=1; i<=config.preloadPrev; i++) {
                    let idx = (currentIndex - i) % fileList.length;
                    if(idx < 0) idx += fileList.length; // ä¿®æ­£è´Ÿæ•°ç´¢å¼•
                    const img = new Image();
                    img.src = URL.createObjectURL(fileList[idx]);
                }
            }
        }

        // --- è¿ç»­ç¿»é¡µæ¸²æŸ“ ---
        /**
         * æ¸²æŸ“è¿ç»­æ¨¡å¼ä¸­çš„å ä½å›¾ç‰‡å…ƒç´ ã€‚
         * æ¯ä¸ªå…ƒç´ è®¾ç½® aspect-ratio ä»¥ä¿æŒæ­£ç¡®å®½åº¦ï¼Œæš‚ä¸è®¾ç½® srcï¼Œ
         * å…·ä½“åŠ è½½ç”± updateLoadedImages æ§åˆ¶ã€‚
         */
        function renderContinuous() {
            continuousStrip.innerHTML = '';
            continuousImgEls = [];
            // åˆ›å»ºæ¯ä¸ªå ä½ img
            for (let i = 0; i < fileList.length; i++) {
                const img = document.createElement('img');
                img.className = 'continuous-img';
                // ä½¿ç”¨ CSS å±æ€§ä¿æŒæ¯”ä¾‹ã€‚è‹¥ ratioList æœªå‡†å¤‡ï¼Œåˆ™é»˜è®¤ 1
                const ratio = ratioList && ratioList[i] ? ratioList[i] : 1;
                // è®¾ç½® aspect-ratioï¼Œç¡®ä¿å³ä¾¿æ²¡æœ‰ src ä¹Ÿå æ®å®½åº¦
                img.style.aspectRatio = ratio;
                // é˜²æ­¢ flex æ”¶ç¼©
                img.style.flex = '0 0 auto';
                // æ‡’åŠ è½½å±æ€§
                img.loading = 'lazy';
                img.decoding = 'async';
                // ç‚¹å‡»åˆ‡æ¢ç´¢å¼•ï¼Œä½†åœ¨æ‹–æ‹½åé¦–æ¬¡ç‚¹å‡»ä¸ç”Ÿæ•ˆ
                (function(index) {
                    img.onclick = () => {
                        if (justDragged) { justDragged = false; return; }
                        currentIndex = index;
                        scrollToIndex(currentIndex);
                        updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                        updatePlaylistHighlight();
                        doPreload();
                        updateLoadedImages();
                    };
                })(i);
                continuousStrip.appendChild(img);
                continuousImgEls[i] = img;
            }
            // åˆå§‹åŠ è½½å½“å‰ç´¢å¼•å‘¨å›´çš„å›¾ç‰‡
            updateLoadedImages();
        }

        // å°†æŒ‡å®šç´¢å¼•çš„å›¾ç‰‡æ»šåŠ¨è‡³è§†å›¾å·¦ä¾§
        function scrollToIndex(idx) {
            const imgEl = continuousStrip.children[idx];
            if (!imgEl) return;
            // ç›´æ¥å°†æ»šåŠ¨ä½ç½®è®¾ç½®åˆ°ç›®æ ‡å›¾ç‰‡çš„èµ·å§‹ä½ç½®ï¼Œä»¥ä¿è¯å·¦å¯¹é½
            continuousContainer.scrollLeft = imgEl.offsetLeft;
            // æ›´æ–°åŠ è½½èŒƒå›´ï¼Œç¡®ä¿æ–°ç´¢å¼•å‘¨å›´çš„å›¾ç‰‡è¢«åŠ è½½
            updateLoadedImages();
        }

        // æ ¹æ®æ»šåŠ¨æ¡ä½ç½®ç¡®å®šå½“å‰ç´¢å¼•å¹¶æ›´æ–°çŠ¶æ€
        function updateCurrentIndexFromScroll() {
            if (fileList.length === 0) return;
            const containerRect = continuousContainer.getBoundingClientRect();
            let closest = Infinity;
            let idx = currentIndex;
            const children = continuousStrip.children;
            for (let i = 0; i < children.length; i++) {
                const rect = children[i].getBoundingClientRect();
                const dist = Math.abs(rect.left - containerRect.left);
                if (dist < closest) {
                    closest = dist;
                    idx = i;
                }
            }
            if (idx !== currentIndex) {
                currentIndex = idx;
                updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                updatePlaylistHighlight();
                // åœ¨è¿ç»­æ¨¡å¼ä¸­æ›´æ–°åŠ è½½èŒƒå›´
                updateLoadedImages();
                // é¢„åŠ è½½åŒå±‚æ¨¡å¼é€»è¾‘å¯¹äºè¿ç»­æ¨¡å¼ä»…ç”¨äºæŒ‰é”®åˆ‡æ¢ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
            }
        }

        /**
         * æ ¹æ®å½“å‰ç´¢å¼•å’Œé¢„åŠ è½½é…ç½®ï¼Œåœ¨è¿ç»­æ¨¡å¼ä¸‹åŠ¨æ€åŠ è½½å›¾ç‰‡ã€‚
         * ä»…åœ¨å½“å‰ç´¢å¼•å‰åæŒ‡å®šèŒƒå›´å†…èµ‹å€¼ srcï¼Œå…¶ä½™ä¿æŒç©ºä»¥èŠ‚çœå†…å­˜ã€‚
         */
        function updateLoadedImages() {
            if (config.pageMode !== 'continuous' || fileList.length === 0) return;
            const n = fileList.length;
            const preloadNext = Math.max(0, parseInt(config.preloadNext) || 0);
            const preloadPrev = Math.max(0, parseInt(config.preloadPrev) || 0);
            // è®¡ç®—æ–°çš„åŠ è½½èŒƒå›´ï¼Œé™åˆ¶åœ¨ [0, n-1]
            let start = currentIndex - preloadPrev;
            let end = currentIndex + preloadNext;
            if (start < 0) start = 0;
            if (end >= n) end = n - 1;
            // å¸è½½æ—§èŒƒå›´ä¹‹å¤–çš„å›¾ç‰‡
            if (lastLoadEnd >= lastLoadStart) {
                for (let i = lastLoadStart; i <= lastLoadEnd; i++) {
                    if (i < start || i > end) {
                        if (loadedFlags[i]) {
                            const img = continuousImgEls[i];
                            // æ¸…ç©º src ä»¥é‡Šæ”¾å†…å­˜
                            img.src = '';
                            img.onload = null;
                            loadedFlags[i] = false;
                        }
                    }
                }
            }
            // åŠ è½½æ–°èŒƒå›´å†…æœªåŠ è½½çš„å›¾ç‰‡
            for (let i = start; i <= end; i++) {
                if (!loadedFlags[i]) {
                    const file = fileList[i];
                    const url = URL.createObjectURL(file);
                    const img = continuousImgEls[i];
                    img.onload = () => {
                        // åŠ è½½å®Œæˆåè®¡ç®—æ¯”ä¾‹å¹¶æ›´æ–°å ä½å®½åº¦
                        const w = img.naturalWidth || 1;
                        const h = img.naturalHeight || 1;
                        const ratio = h === 0 ? 1 : w / h;
                        ratioList[i] = ratio;
                        img.style.aspectRatio = ratio;
                        URL.revokeObjectURL(url);
                    };
                    img.src = url;
                    loadedFlags[i] = true;
                }
            }
            // æ›´æ–°è®°å½•
            lastLoadStart = start;
            lastLoadEnd = end;
        }

        /**
         * è®¡ç®—æ¯ä¸ªå›¾åƒçš„å®½é«˜æ¯”ï¼Œå¹¶åœ¨å®Œæˆåæ¸²æŸ“è¿ç»­æ¨¡å¼ã€‚
         * è¯»å– naturalWidth/naturalHeight æ¥ä¿æŒå ä½å®½åº¦ä¸€è‡´ã€‚
         */
        function computeRatiosAndRender() {
            const n = fileList.length;
            ratioList = new Array(n).fill(1);
            loadedFlags = new Array(n).fill(false);
            continuousImgEls = [];
            lastLoadStart = 0;
            lastLoadEnd = -1;
            if (n === 0) return;
            let remaining = n;
            fileList.forEach((file, idx) => {
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => {
                    const w = img.naturalWidth || 1;
                    const h = img.naturalHeight || 1;
                    ratioList[idx] = h === 0 ? 1 : w / h;
                    URL.revokeObjectURL(url);
                    remaining--;
                    if (remaining === 0) {
                        // è®¡ç®—å®Œæˆåæ¸²æŸ“å¹¶æ»šåŠ¨åˆ°å½“å‰ç´¢å¼•
                        renderContinuous();
                        scrollToIndex(currentIndex);
                        updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                        updatePlaylistHighlight();
                        doPreload();
                        updateLoadedImages();
                    }
                };
                img.onerror = () => {
                    ratioList[idx] = 1;
                    URL.revokeObjectURL(url);
                    remaining--;
                    if (remaining === 0) {
                        renderContinuous();
                        scrollToIndex(currentIndex);
                        updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                        updatePlaylistHighlight();
                        doPreload();
                        updateLoadedImages();
                    }
                };
                img.src = url;
            });
        }

        // --- æ–‡ä»¶å¤„ç† ---
        ['dragenter','dragover','dragleave','drop'].forEach(e => document.body.addEventListener(e, ev => {ev.preventDefault();ev.stopPropagation();}));
        document.body.addEventListener('drop', (e) => {
            let newFiles = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if(newFiles.length===0) return;
            newFiles.sort((a,b)=>a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));

            if(isAppendMode && fileList.length > 0) {
                fileList = fileList.concat(newFiles);
                document.getElementById('list-count').innerText = fileList.length;
                renderPlaylist(false);
                updateMetadataData(currentIndex+1, fileList.length, fileList[currentIndex]);
            } else {
                fileList = newFiles; currentIndex = 0;
                document.getElementById('drop-zone').style.display = 'none';
                document.getElementById('list-count').innerText = fileList.length;
                renderPlaylist(true);
                loadCurrent();
            }
            // æ–°æ–‡ä»¶åŠ è½½æ—¶é‡ç½®æ¯”ä¾‹å’ŒåŠ è½½çŠ¶æ€ï¼Œä»¥ä¾¿è¿ç»­æ¨¡å¼è™šæ‹ŸåŒ–æ­£å¸¸å·¥ä½œ
            ratioList = new Array(fileList.length).fill(1);
            loadedFlags = new Array(fileList.length).fill(false);
            lastLoadStart = 0;
            lastLoadEnd = -1;
            // æ ¹æ®å½“å‰ç¿»é¡µæ¨¡å¼åº”ç”¨å±•ç¤ºæ–¹å¼
            applyPageMode();
        });

        // --- åˆ—è¡¨æ¸²æŸ“ ---
        function renderPlaylist(isReset = true) {
            if(isReset) playlistList.innerHTML = '';
            const frag = document.createDocumentFragment();
            
            const obs = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if(entry.isIntersecting) {
                        loadThumb(entry.target);
                        obs.unobserve(entry.target);
                    }
                });
            }, { root: playlistList, rootMargin: "200px" });

            const start = isReset ? 0 : playlistList.children.length;
            for(let i=start; i<fileList.length; i++) {
                const li = document.createElement('li');
                li.className = i===currentIndex?'list-item active':'list-item';
                li.onclick = () => {
                    currentIndex = i;
                    if (config.pageMode === 'continuous') {
                        scrollToIndex(currentIndex);
                        updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                        updatePlaylistHighlight();
                        doPreload();
                    } else {
                        loadCurrent();
                    }
                };
                
                // å®¹å™¨
                const box = document.createElement('div');
                box.className = 'thumb-box'; box.dataset.fileIdx = i;
                obs.observe(box);
                
                // æ–‡ä»¶å
                const span = document.createElement('span');
                span.className = 'file-name-list'; span.innerText = fileList[i].name;
                
                li.appendChild(box); li.appendChild(span);
                frag.appendChild(li);
            }
            playlistList.appendChild(frag);
            if(isReset) updatePlaylistHighlight();
        }

        function loadThumb(box) {
            const f = fileList[box.dataset.fileIdx];
            const url = URL.createObjectURL(f);
            if(config.useDynamicThumbs) {
                const img = document.createElement('img');
                img.className = 'thumb-img'; img.src = url;
                box.appendChild(img);
            } else {
                const c = document.createElement('canvas');
                c.className = 'thumb-canvas'; c.width=200; c.height=200;
                const ctx = c.getContext('2d');
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    const r = Math.min(200/img.width, 200/img.height);
                    const w=img.width*r, h=img.height*r;
                    ctx.drawImage(img, (200-w)/2, (200-h)/2, w, h);
                    img.src=""; URL.revokeObjectURL(url);
                };
                box.appendChild(c);
            }
        }

        function updatePlaylistHighlight() {
            const items = playlistList.children;
            for(let i=0; i<items.length; i++) items[i].classList.remove('active');
            const curr = items[currentIndex];
            if(curr) {
                curr.classList.add('active');
                if(playlistPanel.classList.contains('open')) {
                    curr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        // --- äº¤äº’æ§åˆ¶ ---
        function nextImage() {
            if (fileList.length === 0) return;
            if (config.pageMode === 'continuous') {
                currentIndex = (currentIndex + 1) % fileList.length;
                scrollToIndex(currentIndex);
                updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                updatePlaylistHighlight();
                doPreload();
            } else {
                currentIndex = (currentIndex + 1) % fileList.length;
                loadCurrent();
            }
        }
        function prevImage() {
            if (fileList.length === 0) return;
            if (config.pageMode === 'continuous') {
                currentIndex = (currentIndex - 1 + fileList.length) % fileList.length;
                scrollToIndex(currentIndex);
                updateMetadataData(currentIndex + 1, fileList.length, fileList[currentIndex]);
                updatePlaylistHighlight();
                doPreload();
            } else {
                currentIndex = (currentIndex - 1 + fileList.length) % fileList.length;
                loadCurrent();
            }
        }
        
        const btnPlay = document.getElementById('btn-play');
        btnPlay.onclick = () => {
            isPlaying = !isPlaying;
            if(isPlaying) {
                btnPlay.innerText = "â¸"; btnPlay.classList.add('active-btn');
                nextImage();
                playTimer = setInterval(nextImage, parseFloat(document.getElementById('interval-input').value)*1000);
            } else {
                btnPlay.innerText = "â–¶"; btnPlay.classList.remove('active-btn');
                clearInterval(playTimer);
            }
        };

        document.getElementById('btn-next').onclick = nextImage;
        document.getElementById('btn-prev').onclick = prevImage;
        
        const toggleList = () => {
            playlistPanel.classList.toggle('open');
            settingsPanel.classList.remove('open');
            if(playlistPanel.classList.contains('open')) updatePlaylistHighlight();
        };
        document.getElementById('btn-toggle-list').onclick = toggleList;
        document.getElementById('btn-close-list').onclick = () => playlistPanel.classList.remove('open');
        document.getElementById('btn-settings').onclick = () => { settingsPanel.classList.toggle('open'); playlistPanel.classList.remove('open'); };
        document.getElementById('btn-close-settings').onclick = () => settingsPanel.classList.remove('open');
        
        document.getElementById('btn-fullscreen').onclick = () => {
            if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(console.error);
            else if(document.exitFullscreen) document.exitFullscreen();
        };

        const sc = ['fit-contain','fit-cover','fit-none'];
        document.getElementById('btn-scale').onclick = () => {
            resetZoom();
            layerA.className = `viewer-layer ${sc[(scaleMode+1)%3]}`;
            layerB.className = `viewer-layer ${sc[(scaleMode+1)%3]}`;
            if(activeLayer===0) layerA.classList.add('active'); else layerB.classList.add('active');
            scaleMode = (scaleMode+1)%3;
        };

        document.getElementById('btn-hide-mode').onclick = () => {
            isHiddenMode = !isHiddenMode;
            if(isHiddenMode) { document.getElementById('controls-container').classList.add('hidden-mode'); document.body.classList.add('hidden-mode-active'); document.getElementById('btn-hide-mode').innerText="ğŸ”’"; }
            else { document.getElementById('controls-container').classList.remove('hidden-mode'); document.body.classList.remove('hidden-mode-active'); document.getElementById('btn-hide-mode').innerText="ğŸ‘"; }
        };

        // å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // å¦‚æœæ­£åœ¨è®¾ç½®å¿«æ·é”®ï¼Œåˆ™å¿½ç•¥
            if(document.querySelector('.key-btn.recording')) return;
            // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†/ä¸‹æ‹‰æ¡†/æ–‡æœ¬åŒºåŸŸå†…ï¼Œåˆ™ä¸å“åº”å…¨å±€å¿«æ·é”®ï¼Œé¿å…å¹²æ‰°
            const el = e.target || document.activeElement;
            if (el && (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA')) return;
            if(fileList.length === 0) return;
            const k = e.key;
            const map = config.keyMap;

            // helper: check if pressed key matches configured key(s)
            const matches = (confVal) => {
                if (!confVal) return false;
                if (Array.isArray(confVal)) {
                    return confVal.some(v => String(v).toLowerCase() === k.toLowerCase());
                }
                return String(confVal).toLowerCase() === k.toLowerCase();
            };

            if(matches(map.info)) { e.preventDefault(); globalInfoVisible = !globalInfoVisible; updateMetadataUI(); return; }
            // ç©ºæ ¼æš‚åœ/æ’­æ”¾
            if(k === ' ') { e.preventDefault(); btnPlay.click(); return; }
            // Ctrl+0 é‡ç½®ç¼©æ”¾
            if(k === '0' && e.ctrlKey) { e.preventDefault(); resetZoom(); return; }
            // ä¸‹ä¸€å¼ /ä¸Šä¸€å¼ 
            if(matches(map.next)) { nextImage(); return; }
            if(matches(map.prev)) { prevImage(); return; }
            // åˆ‡æ¢åˆ—è¡¨
            if(matches(map.toggleList)) { toggleList(); return; }
            // è®¾ç½®
            if(matches(map.settings)) { document.getElementById('btn-settings').click(); return; }
            // å…¨å±
            if(matches(map.fullscreen)) { document.getElementById('btn-fullscreen').click(); return; }
        });

        mainArea.addEventListener('click', () => {
            // å¦‚æœè®¾ç½®é¢æ¿å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œå…ˆåº”ç”¨ç¿»é¡µæ¨¡å¼é€‰æ‹©
            if (settingsPanel.classList.contains('open')) {
                const flipSelect = document.getElementById('cfg-flip-mode');
                if (flipSelect) {
                    const val = flipSelect.value;
                    if (val && val !== config.pageMode) {
                        config.pageMode = val;
                        saveConfig();
                        applyPageMode();
                    }
                }
            }
            settingsPanel.classList.remove('open');
            playlistPanel.classList.remove('open');
        });
        settingsPanel.onmousedown = e => e.stopPropagation();
        playlistPanel.onmousedown = e => e.stopPropagation();
        document.getElementById('controls-container').onmousedown = e => e.stopPropagation();

        init();
    </script>
</body>
</html>